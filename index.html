<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mechanic HOBOT Calculator v.1.4</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- html2pdf.js for PDF report export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Three.js & OrbitControls -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; }
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .input-group label { font-size: 0.75rem; color: #94a3b8; display: block; margin-bottom: 0.35rem; font-weight: 500; }
        .input-group input, .input-group select { 
            width: 100%; 
            background: #1e293b; 
            border: 1px solid #334155; 
            color: #f8fafc; 
            padding: 0.5rem 0.625rem; 
            border-radius: 0.375rem; 
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25); }
        .input-group input[type="color"] {
            padding: 0.1rem;
            height: 2.5rem;
        }
        /* Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
        /* Remove default spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        
        .result-card { background: #1e293b; padding: 1rem 1.25rem; border-radius: 0.5rem; margin-bottom: 0.75rem; border-left: 4px solid #3b82f6; }
        .result-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
        .result-value { font-size: 1.25rem; font-weight: 700; color: #f1f5f9; }
        .result-unit { font-size: 0.75rem; color: #64748b; margin-left: 0.25rem; }

        .warning-box { background: #451a03; border-left-color: #f59e0b; color: #fbbf24; }
        .error-box { background: #450a0a; border-left-color: #ef4444; color: #fca5a5; }

        #canvas-container { width: 100%; height: 100%; position: relative; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; }

        /* Mobile Tab Active State */
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; background-color: #1e293b; }
        .tab-inactive { color: #64748b; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen text-slate-200 font-sans overflow-hidden">

    <!-- 3D VIEW (Order 1 on Mobile, Order 2 on Desktop) -->
    <div class="relative order-1 md:order-2 w-full h-[40vh] md:h-full md:flex-1 bg-black flex flex-col shrink-0">
        <div id="canvas-container">
            <div id="loading">Loading 3D Engine...</div>
        </div>
        
        <!-- Overlay HUD -->
        <div class="absolute top-4 left-4 bg-black/60 backdrop-blur-sm p-3 rounded border border-slate-700 pointer-events-none select-none z-10">
            <div class="text-xs text-slate-400">Simulation Status</div>
            <div class="text-sm font-bold text-green-400"><span id="anim-rpm">0.0</span> <span id="anim-rpm-unit">RPM</span></div>
            <div class="text-xs text-slate-500 mt-1">Viewing: <span id="view-dim">20</span>m <span id="view-dim-label">Stage</span></div>
            <div class="text-xs text-blue-400 mt-1">Drive Radius: <span id="view-drive-rad">9.5</span>m</div>
        </div>

        <!-- Camera Home Button -->
        <button id="btn-home-cam" class="absolute bottom-4 right-4 bg-slate-800 hover:bg-slate-700 text-white w-10 h-10 rounded-full shadow-lg border border-slate-600 flex items-center justify-center transition-all z-20" title="Reset Camera">
            <i class="fa-solid fa-house"></i>
        </button>
    </div>

    <!-- MOBILE TABS (Order 2 on Mobile, Hidden on Desktop) -->
    <div class="order-2 md:hidden flex h-12 bg-slate-900 border-b border-slate-800 shrink-0 z-20">
        <button id="tab-inputs" class="flex-1 font-bold text-sm transition-colors tab-active">
            <i class="fa-solid fa-sliders mr-2"></i>Inputs
        </button>
        <button id="tab-results" class="flex-1 font-bold text-sm transition-colors tab-inactive">
            <i class="fa-solid fa-chart-pie mr-2"></i>Results
        </button>
    </div>

    <!-- LEFT SIDEBAR: INPUTS (Order 3 on Mobile, Order 1 on Desktop) -->
    <div id="sidebar-inputs" class="order-3 md:order-1 w-full md:w-80 bg-slate-900 border-r border-slate-800 flex flex-col h-full overflow-y-auto z-10 shadow-xl">
        <div class="p-5 border-b border-slate-800 bg-slate-900 sticky top-0 z-20">
            <h1 class="text-xl font-bold text-blue-500 tracking-tight"><i class="fa-solid fa-calculator mr-2"></i> Mechanic HOBOT Calculator <span class="text-slate-500 font-normal text-sm">v.1.4</span></h1>
            <div class="flex gap-1 mt-2">
                <button type="button" id="btn-save-project" class="flex-1 bg-slate-700 hover:bg-slate-600 text-xs py-1.5 rounded border border-slate-600" title="Download project file"><i class="fa-solid fa-floppy-disk mr-1"></i> Save File</button>
                <label class="flex-1 bg-slate-700 hover:bg-slate-600 text-xs py-1.5 rounded border border-slate-600 cursor-pointer text-center" title="Load from file"><input type="file" id="input-import-project" accept=".json" class="hidden"> <i class="fa-solid fa-file-import mr-1"></i> Load File</label>
            </div>
            <!-- APPLICATION MODE: Turntable | Linear Track -->
            <div class="bg-slate-800 p-1 rounded-lg flex mt-3 border border-slate-700">
                <button id="app-mode-turntable" class="flex-1 py-1.5 px-2 rounded-md bg-blue-600 text-white text-xs font-bold transition-all shadow-lg">
                    <i class="fa-solid fa-rotate mr-1"></i> Turntable
                </button>
                <button id="app-mode-linear" class="flex-1 py-1.5 px-2 rounded-md text-slate-400 text-xs font-bold hover:text-white hover:bg-slate-700 transition-all">
                    <i class="fa-solid fa-arrows-left-right mr-1"></i> Linear Track
                </button>
            </div>
            <!-- CALC MODE: Power | Load -->
            <div class="bg-slate-800 p-1 rounded-lg flex mt-2 border border-slate-700">
                <button id="mode-normal" class="flex-1 py-1.5 px-2 rounded-md bg-emerald-600 text-white text-xs font-bold transition-all shadow-lg">
                    Calc Power
                </button>
                <button id="mode-reverse" class="flex-1 py-1.5 px-2 rounded-md text-slate-400 text-xs font-bold hover:text-white hover:bg-slate-700 transition-all">
                    Calc Load
                </button>
            </div>
        </div>

        <div class="p-5 space-y-5 pb-20 md:pb-5">
            <!-- Geometry -->
            <div class="space-y-3">
                <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider border-b border-slate-700 pb-2">Primary Inputs</h3>
                
                <div class="input-group">
                    <label id="label-diameter" title="Turntable: stage diameter. Linear: track length.">Turntable Diameter (m)</label>
                    <input type="number" id="diameter" value="20" step="0.5" min="1">
                </div>

                <!-- DYNAMIC INPUT: MASS OR POWER -->
                <div id="input-container-mass" class="input-group transition-all">
                    <label class="text-blue-300" title="Total mass of rotating stage + load (metric tons)">Total Moving Mass (Tons)</label>
                    <input type="number" id="mass" value="100" step="1" min="1" class="border-blue-900/50 bg-blue-900/10 focus:border-blue-500">
                </div>

                <div id="input-container-power" class="input-group hidden transition-all">
                    <label class="text-emerald-300">Motor Power per Motor (kW)</label>
                    <input type="number" id="inputPower" value="5.5" step="0.5" min="0.1" class="border-emerald-900/50 bg-emerald-900/10 focus:border-emerald-500">
                    <div class="mt-3 space-y-2">
                        <div class="input-group">
                            <label class="text-emerald-200">Motor Type</label>
                            <select id="motorType" class="border-emerald-900/50 bg-emerald-900/10 focus:border-emerald-500">
                                <option value="servo" selected>Servo</option>
                                <option value="induction">Induction</option>
                            </select>
                        </div>
                        <div id="motor-pole-container" class="input-group hidden">
                            <label class="text-emerald-200">Induction Motor Poles</label>
                            <select id="motorPole" class="border-emerald-900/50 bg-emerald-900/10 focus:border-emerald-500">
                                <option value="2">2 Poles</option>
                                <option value="4" selected>4 Poles</option>
                                <option value="6">6 Poles</option>
                                <option value="8">8 Poles</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kinematics -->
            <div class="space-y-3 pt-2">
                <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider border-b border-slate-700 pb-2">Kinematics</h3>
                <div class="input-group">
                    <label id="label-rpm" title="Turntable: stage RPM. Linear: speed in selected unit.">Target Speed (RPM)</label>
                    <div id="rpm-input-wrap" class="flex gap-2 items-center">
                        <input type="number" id="rpm" value="1" step="0.1" min="0.1" class="flex-1">
                        <div id="linear-speed-unit-btns" class="hidden flex rounded-md overflow-hidden border border-slate-600 bg-slate-800 shrink-0">
                            <button type="button" id="linearSpeedMs" class="px-2 py-1.5 text-xs font-medium bg-blue-600 text-white border-r border-slate-600">m/s</button>
                            <button type="button" id="linearSpeedMmin" class="px-2 py-1.5 text-xs font-medium text-slate-400 hover:bg-slate-700 border-r border-slate-600">m/min</button>
                        </div>
                    </div>
                    <div id="linear-speed-convert" class="text-[11px] text-slate-500 mt-1 hidden"></div>
                </div>
                <div class="flex gap-2">
                    <div class="input-group flex-1">
                        <label title="Time from standstill to target speed">Acceleration Time (sec)</label>
                        <input type="number" id="accelTime" value="15" step="1" min="1">
                    </div>
                    <div class="input-group flex-1">
                        <label title="Time from full speed to stop">Deceleration Time (sec)</label>
                        <input type="number" id="decelTime" value="15" step="1" min="1">
                    </div>
                </div>
                <div class="input-group">
                    <label title="S-Curve reduces jerk; peak torque is higher than linear ramp">Acceleration Profile</label>
                    <div class="flex gap-2">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="accelProfile" value="linear" checked class="peer sr-only">
                            <div class="text-center py-1.5 rounded border border-slate-600 bg-slate-700 peer-checked:bg-slate-600 peer-checked:border-slate-500 text-xs text-slate-300 transition-all">Linear</div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="accelProfile" value="s-curve" class="peer sr-only">
                            <div class="text-center py-1.5 rounded border border-slate-600 bg-slate-700 peer-checked:bg-slate-600 peer-checked:border-slate-500 text-xs text-slate-300 transition-all">S-Curve</div>
                        </label>
                    </div>
                </div>
                <div id="s-curve-factor-wrap" class="input-group hidden">
                    <label title="Peak acceleration multiplier vs linear (typical 1.3–2.0)">S-Curve peak factor</label>
                    <input type="number" id="sCurveFactor" value="1.5" step="0.1" min="1.1" max="2.5">
                </div>
            </div>

            <!-- Drive System -->
            <div class="space-y-3 pt-2">
                <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider border-b border-slate-700 pb-2">Drive System</h3>
                
                <!-- Drive Type Switcher -->
                <div class="bg-slate-800 p-2 rounded border border-slate-700 mb-2">
                    <label class="text-xs text-slate-400 uppercase font-bold mb-2 block">Transmission Type</label>
                    <div class="flex gap-2">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="driveType" value="wheel" checked class="peer sr-only">
                            <div class="text-center py-1.5 rounded bg-slate-700 peer-checked:bg-blue-500 peer-checked:text-white text-xs text-slate-300 transition-all border border-slate-600 peer-checked:border-blue-400">
                                <i class="fa-solid fa-compact-disc mr-1"></i> Wheel
                            </div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="driveType" value="gear" class="peer sr-only">
                            <div class="text-center py-1.5 rounded bg-slate-700 peer-checked:bg-amber-600 peer-checked:text-white text-xs text-slate-300 transition-all border border-slate-600 peer-checked:border-amber-500">
                                <i class="fa-solid fa-gear mr-1"></i> Gear
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Motor Position Slider (Turntable only) -->
                <div id="drive-radius-section" class="input-group bg-slate-800 p-2 rounded border border-slate-700">
                    <label class="text-blue-300">Drive Radius (Position)</label>
                    <div class="flex items-center gap-2">
                        <input type="range" id="driveRadiusSlider" min="0.1" max="10" step="0.1" value="9.5" class="flex-1">
                        <span class="text-xs w-12 text-right"><span id="driveRadiusVal">9.5</span> m</span>
                    </div>
                    <div class="text-[10px] text-slate-500 mt-1">Distance from Center</div>
                    <div id="drive-radius-gear-note" class="text-[10px] text-amber-400 mt-1 hidden">
                        Gear drive torque depends on gear ratio; drive radius affects visualization only.
                    </div>
                </div>

                <!-- Motors Count -->
                <div class="input-group">
                    <label>Number of Drive Motors</label>
                    <div class="flex h-10">
                        <button type="button" id="motorDec" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-3 rounded-l-md border border-slate-600 transition-colors font-bold text-lg">-</button>
                        <input type="number" id="motors" value="4" step="1" min="1" class="flex-1 text-center bg-slate-800 border-y border-slate-600 focus:outline-none focus:border-blue-500 rounded-none h-full m-0 text-white font-bold">
                        <button type="button" id="motorInc" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-3 rounded-r-md border border-slate-600 transition-colors font-bold text-lg">+</button>
                    </div>
                </div>

                <!-- DYNAMIC DRIVE INPUTS -->
                <div id="drive-input-wheel" class="input-group">
                    <label id="label-wheel-or-pinion">Drive Wheel Diameter</label>
                    <div class="flex gap-2 items-center">
                        <input type="number" id="wheelDia" value="400" step="0.1" min="1" class="flex-1">
                        <div class="flex rounded-md overflow-hidden border border-slate-600 bg-slate-800 shrink-0">
                            <button type="button" id="wheelUnitMm" class="px-2.5 py-1.5 text-xs font-medium bg-blue-600 text-white border-r border-slate-600">mm</button>
                            <button type="button" id="wheelUnitInch" class="px-2.5 py-1.5 text-xs font-medium text-slate-400 hover:bg-slate-700 border-r border-slate-600">in</button>
                        </div>
                    </div>
                    <div class="text-[11px] text-slate-500 mt-1.5" id="wheelDiaConvert">≈ 15.75 in</div>
                </div>

                <div id="drive-input-gear" class="hidden flex gap-2">
                    <div class="input-group w-1/2">
                        <label class="text-amber-300">Turntable Teeth</label>
                        <input type="number" id="teethTurntable" value="300" step="1" class="border-amber-900/50 focus:border-amber-500">
                    </div>
                    <div class="input-group w-1/2">
                        <label class="text-amber-300">Pinion Teeth</label>
                        <input type="number" id="teethPinion" value="15" step="1" class="border-amber-900/50 focus:border-amber-500">
                    </div>
                </div>

                <!-- Linear Track + Gear: Rack & Pinion (Module + Teeth, standard presets) -->
                <div id="drive-input-linear-gear" class="hidden space-y-3">
                    <div class="input-group">
                        <label class="text-amber-300">Standard gear</label>
                        <select id="linearGearPreset" class="border-amber-900/50 bg-amber-900/10 focus:border-amber-500">
                            <option value="1-20">M1, 20 teeth (Ø20 mm)</option>
                            <option value="1.5-20">M1.5, 20 teeth (Ø30 mm)</option>
                            <option value="2-20">M2, 20 teeth (Ø40 mm)</option>
                            <option value="2-24">M2, 24 teeth (Ø48 mm)</option>
                            <option value="2.5-24">M2.5, 24 teeth (Ø60 mm)</option>
                            <option value="3-20">M3, 20 teeth (Ø60 mm)</option>
                            <option value="3-24">M3, 24 teeth (Ø72 mm)</option>
                            <option value="4-25">M4, 25 teeth (Ø100 mm)</option>
                            <option value="5-20">M5, 20 teeth (Ø100 mm)</option>
                            <option value="5-24">M5, 24 teeth (Ø120 mm)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <div class="input-group flex-1">
                            <label class="text-amber-300">Module / Pitch (mm)</label>
                            <input type="number" id="linearGearModule" value="2" step="0.5" min="0.5" class="border-amber-900/50 focus:border-amber-500">
                        </div>
                        <div class="input-group flex-1">
                            <label class="text-amber-300">Pinion teeth</label>
                            <input type="number" id="linearGearTeeth" value="20" step="1" min="1" class="border-amber-900/50 focus:border-amber-500">
                        </div>
                    </div>
                    <div class="text-[11px] text-slate-500">Pitch diameter: <span id="linearGearPitchDia">40</span> mm</div>
                </div>

                <div class="input-group">
                    <label class="text-red-300"><i class="fa-solid fa-gauge-high mr-1"></i>Rated Motor Speed (RPM)</label>
                    <input type="number" id="maxMotorRpm" value="1500" step="10" class="border-red-900/50 bg-red-900/10 focus:border-red-500 focus:ring-red-500">
                </div>
                <div class="flex gap-2">
                    <div class="input-group w-1/2">
                        <label title="Stage (or pinion) speed reduction ratio to motor">Gearbox Ratio (i)</label>
                        <input type="number" id="gearRatio" value="30" step="1">
                    </div>
                    <div class="input-group w-1/2">
                        <label title="Combined efficiency of gearbox and drive">Efficiency (η)</label>
                        <input type="number" id="efficiency" value="0.9" step="0.05" max="1" min="0.1">
                    </div>
                </div>
                <div class="input-group">
                    <label title="Multiplier for peak torque when selecting gearbox (e.g. 1.5 = 50% margin)">Safety Factor (Peak Torque)</label>
                    <input type="number" id="safetyFactor" value="1.5" step="0.1" min="1" max="3">
                </div>
            </div>

            <!-- Advanced / Friction -->
            <div class="space-y-3 pt-2">
                <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider border-b border-slate-700 pb-2">Friction Coeffs (μ)</h3>
                <div class="flex gap-2 mb-2">
                    <div class="input-group w-1/2">
                        <label title="Coefficient during motion (rolling resistance)">Rolling (Dynamic)</label>
                        <input type="number" id="muRolling" value="0.02" step="0.005" min="0.001">
                    </div>
                    <div class="input-group w-1/2">
                        <label title="Coefficient at breakaway (start-up)">Static (Start)</label>
                        <input type="number" id="muStatic" value="0.05" step="0.005" min="0.001">
                    </div>
                </div>
                <!-- PRESET BUTTONS -->
                <div class="flex gap-2">
                    <button id="btn-fric-clean" class="flex-1 bg-slate-800 hover:bg-slate-700 text-xs text-slate-300 py-1 rounded border border-slate-700 transition-colors">
                        <i class="fa-solid fa-sparkles mr-1"></i> Clean
                    </button>
                    <button id="btn-fric-dusty" class="flex-1 bg-slate-800 hover:bg-slate-700 text-xs text-amber-500 py-1 rounded border border-slate-700 transition-colors">
                        <i class="fa-solid fa-wind mr-1"></i> Dusty (x2)
                    </button>
                </div>
            </div>

             <!-- Appearance -->
             <div class="space-y-3 pt-2">
                <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider border-b border-slate-700 pb-2">Appearance</h3>
                <div class="flex gap-2">
                    <div class="input-group w-1/2">
                        <label>Stage Color</label>
                        <input type="color" id="colorStage" value="#475569">
                    </div>
                    <div class="input-group w-1/2">
                        <label>Background</label>
                        <input type="color" id="colorBg" value="#0f172a">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT SIDEBAR: RESULTS (Order 3 on Mobile, Order 3 on Desktop) -->
    <div id="sidebar-results" class="order-3 md:order-3 w-full md:w-80 bg-slate-900 border-l border-slate-800 flex flex-col h-full overflow-y-auto shadow-xl hidden md:flex">
        <div class="p-5 border-b border-slate-800 bg-slate-900 sticky top-0 z-20">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-lg font-bold text-slate-200">Engineering Results</h2>
                <div class="flex gap-1">
                <button id="btn-report" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-bold transition-colors flex items-center gap-1">
                    <i class="fa-solid fa-file-lines"></i> Report
                </button>
                <button id="btn-export-report" class="bg-slate-600 hover:bg-slate-500 text-white px-3 py-1.5 rounded text-xs font-bold transition-colors flex items-center gap-1" title="Download report as file">
                    <i class="fa-solid fa-download"></i> Export
                </button>
            </div>
            </div>
            <p class="text-xs text-slate-500">Real-time Calculation</p>
        </div>

        <div class="p-5 space-y-4 pb-20 md:pb-5">
            <!-- RPM Limit Warning -->
            <div id="rpm-warning" class="result-card error-box hidden">
                <div class="flex items-center gap-2 mb-1">
                    <i class="fa-solid fa-gauge-simple-high"></i>
                    <div class="result-label text-red-200 font-bold">Motor Speed Exceeded!</div>
                </div>
                <div class="text-sm mb-2">
                    Required RPM > Limit. Performance Capped.
                </div>
                <div class="flex justify-between text-xs border-t border-red-800/50 pt-2">
                    <span>Target Stage Speed:</span>
                    <span class="line-through opacity-50" id="warn-target-rpm">0</span>
                </div>
                <div class="flex justify-between text-xs font-bold text-white mt-1">
                    <span>Actual Stage Speed:</span>
                    <span id="warn-actual-rpm">0</span> <span id="warn-speed-unit">RPM</span>
                </div>
            </div>
            
            <!-- MAIN RESULT CARD -->
            <div class="result-card bg-slate-800 border-l-emerald-500" id="main-result-card">
                <div class="result-label text-emerald-400 font-bold mb-2" id="main-result-title"> 
                    <i class="fa-solid fa-clipboard-check"></i> Recommended Motor Spec
                </div>
                
                <!-- Display for Normal Mode -->
                <div id="res-block-normal">
                    <div class="mb-3">
                        <div class="text-xs text-slate-400">Required Motor Speed @ Shaft</div>
                        <span class="result-value text-emerald-300" id="res-motor-rpm">0</span>
                        <span class="result-unit">RPM</span>
                    </div>
                    <div class="mb-3">
                        <div class="text-xs text-slate-400">Required Motor Torque @ Operating Speed</div>
                        <span class="result-value text-emerald-300" id="res-motor-torque">0</span>
                        <span class="result-unit">Nm</span>
                        <div class="text-[10px] text-slate-500 mt-1">At <span id="torque-rpm">0</span> RPM</div>
                    </div>
                    <div class="mb-3 border-t border-slate-700 pt-3">
                        <div class="text-xs text-slate-400">Required Motor Power (Rated)</div>
                        <span class="result-value text-emerald-300" id="res-power">0.00</span>
                        <span class="result-unit">kW</span>
                        <span class="result-value text-emerald-300/70 text-sm ml-2" id="res-power-hp">(0.00 hp)</span>
                        <div class="text-[10px] text-slate-500 mt-1">At Rated RPM (<span id="rated-rpm-display">1500</span> RPM)</div>
                    </div>
                    <div class="mb-3 border-t border-slate-700 pt-2">
                        <div class="text-xs text-slate-400">Recommended Standard Motor</div>
                        <span class="result-value text-amber-300" id="res-standard-motor">—</span>
                        <span class="result-unit">kW</span>
                        <div class="text-[10px] text-slate-500 mt-1">Nearest IEC rating (per motor)</div>
                    </div>
                    <div class="mb-3 border-t border-slate-700 pt-2">
                        <div class="text-xs text-slate-400">Recommended VFD Rating</div>
                        <span class="result-value text-cyan-300" id="res-vfd">—</span>
                        <span class="result-unit">kW</span>
                        <div class="text-[10px] text-slate-500 mt-1">Total drive power · <span id="res-vfd-current">—</span> A</div>
                    </div>
                    <div class="mb-3 border-t border-slate-700 pt-3">
                        <div class="text-xs text-slate-400">Total Power Required</div>
                        <span class="result-value text-emerald-300" id="res-power-total">0.00</span>
                        <span class="result-unit">kW</span>
                        <div class="text-[10px] text-slate-500 mt-1">For <span id="total-motors-count">4</span> Motors</div>
                    </div>
                    <div class="mb-3 border-t border-slate-700 pt-3">
                        <div class="text-xs text-slate-400">Total Apparent Power (VA)</div>
                        <span class="result-value text-blue-300" id="res-power-va">0.00</span>
                        <span class="result-unit">kVA</span>
                        <div class="text-[10px] text-slate-500 mt-1">Building Power Requirement</div>
                    </div>
                    <div class="mb-3 border-t border-slate-700 pt-3">
                        <div class="text-xs text-slate-400">Total Current</div>
                        <span class="result-value text-amber-300" id="res-current">0.00</span>
                        <span class="result-unit">A</span>
                        <div class="text-[10px] text-slate-500 mt-1">Per Phase @ 380V (3-Phase)</div>
                    </div>
                    <div class="text-xs text-slate-500 italic border-t border-slate-700 pt-2">
                        <i class="fa-solid fa-info-circle mr-1"></i>
                        <span id="power-torque-note">Power calculated to ensure torque capability</span>
                    </div>
                </div>

                <!-- Display for Reverse Mode -->
                <div id="res-block-reverse" class="hidden">
                    <div class="mb-3 border-b border-slate-700 pb-2">
                        <div class="text-xs text-slate-400">Max Permissible Load</div>
                        <span class="result-value text-emerald-300 text-3xl" id="res-max-load">0</span>
                        <span class="result-unit text-lg">Tons</span>
                    </div>
                     <div class="mb-1">
                        <div class="text-xs text-slate-400">Limiting Factor</div>
                        <span class="text-xs text-yellow-300" id="res-limit-factor">Static Friction</span>
                    </div>
                    
                    <!-- Electrical Info for Reverse Mode -->
                    <div class="mb-3 border-t border-slate-700 pt-3 mt-3">
                        <div class="flex justify-between items-baseline mb-1">
                             <div class="text-xs text-slate-400">Motor Rated Torque</div>
                             <span class="text-xs text-emerald-400 font-mono"><span id="res-motor-rated-torque">0</span> Nm</span>
                        </div>
                        <div class="text-xs text-slate-400">Total Installed Power</div>
                        <span class="result-value text-emerald-300" id="res-power-total-rev">0.00</span>
                        <span class="result-unit">kW</span>
                        <div class="text-[10px] text-slate-500 mt-1">Input Power × <span id="total-motors-count-rev">4</span> Motors</div>
                    </div>
                    <div class="mb-3 border-t border-slate-700 pt-3">
                        <div class="text-xs text-slate-400">Total Apparent Power (VA)</div>
                        <span class="result-value text-blue-300" id="res-power-va-rev">0.00</span>
                        <span class="result-unit">kVA</span>
                        <div class="text-[10px] text-slate-500 mt-1">Building Power Requirement</div>
                    </div>
                    <div class="mb-3 border-t border-slate-700 pt-3">
                        <div class="text-xs text-slate-400">Total Current</div>
                        <span class="result-value text-amber-300" id="res-current-rev">0.00</span>
                        <span class="result-unit">A</span>
                        <div class="text-[10px] text-slate-500 mt-1">Per Phase @ 380V (3-Phase)</div>
                    </div>

                    <div class="text-[10px] text-slate-500 italic mt-1 border-t border-slate-700 pt-2">
                        *Constrained by Motor Rated Torque at Low RPM
                    </div>
                </div>
            </div>

            <!-- Torque Analysis -->
            <div class="result-card bg-slate-800 border-l-purple-500">
                <div class="result-label text-purple-300 mb-2" id="torque-card-title">System Torque Analysis</div>
                <div class="flex justify-between border-b border-slate-700 pb-1 mb-1">
                    <span class="text-xs text-slate-400">Breakaway (Static)</span>
                    <span class="text-sm font-mono text-pink-400" id="res-t-static">0</span>
                </div>
                <div class="flex justify-between border-b border-slate-700 pb-1 mb-1">
                    <span class="text-xs text-slate-400">Rolling (Dynamic)</span>
                    <span class="text-sm font-mono text-slate-300" id="res-t-fric">0</span>
                </div>
                <div class="flex justify-between pb-1">
                    <span class="text-xs text-slate-400">Acceleration</span>
                    <span class="text-sm font-mono text-slate-300" id="res-t-accel">0</span>
                </div>
                <div class="flex justify-between pb-1">
                    <span class="text-xs text-slate-400" id="res-brake-label">Braking</span>
                    <span class="text-sm font-mono text-slate-300" id="res-brake">0</span>
                </div>
                <div class="mt-2 pt-2 border-t border-slate-600">
                    <div class="text-xs text-slate-500" id="peak-torque-label">Design Peak Torque (with SF)</div>
                    <span class="result-value text-purple-400" id="res-peak-torque">0</span>
                    <span class="result-unit">Nm</span>
                    <div class="text-[10px] text-slate-500 italic mt-1" id="peak-reason">Reason: Accel + Rolling</div>
                </div>
            </div>

            <!-- Force Mechanics -->
            <div class="space-y-2">
                <h3 class="text-xs font-semibold text-slate-500 uppercase">Drive Mechanics</h3>
                <div class="flex justify-between items-center text-sm border-b border-slate-800 pb-2">
                    <span class="text-slate-400" id="lbl-force-output">Tangential Force (Per Wheel)</span>
                    <span class="text-slate-200"><span id="res-force-wheel">0</span> kN</span>
                </div>
                <div class="flex justify-between items-center text-sm border-b border-slate-800 pb-2">
                    <span class="text-slate-400" id="lbl-speed-output">Wheel Speed</span>
                    <span class="text-slate-200"><span id="res-wheel-rpm">0</span> RPM</span>
                </div>
                 <div class="flex justify-between items-center text-sm border-b border-slate-800 pb-2">
                    <span class="text-slate-400">Drive Radius</span>
                    <span class="text-slate-200"><span id="res-drive-rad">0</span> m</span>
                </div>
                <div id="res-linear-pitch-row" class="hidden flex justify-between items-center text-sm border-b border-slate-800 pb-2">
                    <span class="text-slate-400">Pinion pitch diameter</span>
                    <span class="text-slate-200"><span id="res-linear-pitch-dia">0</span> mm</span>
                </div>
            </div>

            <!-- Gearbox Torque Requirements -->
            <div class="result-card bg-slate-800 border-l-amber-500">
                <div class="result-label text-amber-300 mb-2">
                    <i class="fa-solid fa-gear mr-1"></i>Gearbox Torque Requirements
                </div>
                <div class="mb-3 border-b border-slate-700 pb-2">
                    <div class="text-xs text-slate-400 mb-1">Nominal Output Torque (Per Motor)</div>
                    <span class="result-value text-amber-300" id="res-gearbox-nominal">0</span>
                    <span class="result-unit">Nm</span>
                    <div class="text-[10px] text-slate-500 mt-1">Continuous Operation</div>
                </div>
                <div class="mb-2">
                    <div class="text-xs text-slate-400 mb-1">Peak Output Torque (Per Motor)</div>
                    <span class="result-value text-orange-400" id="res-gearbox-peak">0</span>
                    <span class="result-unit">Nm</span>
                    <div class="text-[10px] text-slate-500 mt-1">Startup & Acceleration</div>
                </div>
                <div class="text-[10px] text-amber-400/70 italic mt-2 border-t border-slate-700 pt-2">
                    <i class="fa-solid fa-info-circle mr-1"></i>
                    Select gearbox with Peak Torque rating ≥ <span id="res-gearbox-peak-min">0</span> Nm (safety factor: <span id="res-safety-factor">1.5</span>×)
                </div>
            </div>

            <!-- Inertia Ratio (Servo only) -->
            <div id="inertia-ratio-card" class="result-card hidden">
                <div class="text-xs text-slate-400 mb-1">Inertia Ratio (JL/JM)</div>
                <span class="result-value" id="res-inertia-ratio">—</span>
                <div class="text-[10px] text-slate-500 mt-1">Load inertia reflected to motor / Motor rotor inertia</div>
                <div id="inertia-ratio-warning" class="text-[10px] text-amber-400 mt-2 hidden">
                    <i class="fa-solid fa-triangle-exclamation mr-1"></i> Ratio &gt; 10: consider higher ratio gearbox or larger motor for stable servo response.
                </div>
            </div>

            <!-- Safety / Traction -->
            <div id="traction-warning" class="result-card warning-box hidden">
                <div class="flex items-center gap-2 mb-1">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <div class="result-label text-yellow-200">Slippage Risk (Startup)</div>
                </div>
                <div class="text-xs mt-2 opacity-80">
                    Min. Downward Force needed per wheel to overcome Static Friction: <br>
                    <span class="font-bold text-lg" id="res-min-weight">0.0</span> Tons
                </div>
            </div>
        </div>
    </div>

    <!-- REPORT MODAL -->
    <div id="report-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-900 rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-slate-700">
            <div class="sticky top-0 bg-slate-900 border-b border-slate-800 p-5 flex items-center justify-between z-10">
                <h2 class="text-xl font-bold text-blue-400" id="report-title">
                    <i class="fa-solid fa-file-lines mr-2"></i>Technical Specification Report
                </h2>
                <button id="btn-close-report" class="text-slate-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-5 space-y-4">
                <!-- Motor Specification -->
                <div class="bg-slate-800 rounded-lg p-4 border-l-4 border-blue-500">
                    <h3 class="text-sm font-bold text-blue-300 mb-3 uppercase">Motor Specification</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-400">Motor Power (per motor):</span>
                            <span class="text-white font-bold" id="report-power">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Number of Motors:</span>
                            <span class="text-white font-bold" id="report-motors">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Motor Speed (RPM):</span>
                            <span class="text-white font-bold" id="report-motor-rpm">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Total Power:</span>
                            <span class="text-emerald-300 font-bold" id="report-total-power">-</span>
                        </div>
                        <div class="flex justify-between border-t border-slate-700 pt-2 mt-2">
                            <span class="text-slate-400">Total Apparent Power (VA):</span>
                            <span class="text-blue-300 font-bold" id="report-power-va">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Total Current:</span>
                            <span class="text-amber-300 font-bold" id="report-current">-</span>
                        </div>
                        <div class="text-[10px] text-slate-500 mt-2 italic border-t border-slate-700 pt-2">
                            <i class="fa-solid fa-building mr-1"></i>Building Power Requirement: 3-Phase 380V, PF=0.85
                        </div>
                    </div>
                </div>

                <!-- Load Capacity -->
                <div class="bg-slate-800 rounded-lg p-4 border-l-4 border-emerald-500">
                    <h3 class="text-sm font-bold text-emerald-300 mb-3 uppercase">Load Capacity</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-400" id="label-report-load">Maximum Load:</span>
                            <span class="text-emerald-300 font-bold text-lg" id="report-load">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Stage Diameter:</span>
                            <span class="text-white font-bold" id="report-diameter">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Target Stage Speed:</span>
                            <span class="text-white font-bold" id="report-stage-rpm">-</span>
                        </div>
                    </div>
                </div>

                <!-- Drive System -->
                <div class="bg-slate-800 rounded-lg p-4 border-l-4 border-amber-500">
                    <h3 class="text-sm font-bold text-amber-300 mb-3 uppercase">Drive System</h3>
                    <div class="space-y-3">
                        <!-- Drive Type -->
                        <div class="flex justify-between items-center pb-2 border-b border-slate-700">
                            <span class="text-slate-400">Drive Type:</span>
                            <span class="text-white font-bold" id="report-drive-type">-</span>
                        </div>
                        
                        <!-- Wheel Drive Info -->
                        <div id="report-wheel-info" class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Wheel Diameter:</span>
                                <span class="text-white font-bold" id="report-wheel-dia">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Drive Radius:</span>
                                <span class="text-white font-bold" id="report-drive-radius">-</span>
                            </div>
                        </div>

                        <!-- Gear Drive Info -->
                        <div id="report-gear-info" class="hidden space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Turntable Teeth:</span>
                                <span class="text-white font-bold" id="report-teeth-turntable">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Pinion Teeth:</span>
                                <span class="text-white font-bold" id="report-teeth-pinion">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Gear Ratio (Stage:Pinion):</span>
                                <span class="text-white font-bold" id="report-gear-ratio-stage">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Drive Radius:</span>
                                <span class="text-white font-bold" id="report-gear-drive-radius">-</span>
                            </div>
                        </div>

                        <!-- Gearbox -->
                        <div class="pt-2 border-t border-slate-700 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Gearbox Ratio:</span>
                                <span class="text-white font-bold" id="report-gearbox-ratio">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Total Ratio:</span>
                                <span class="text-amber-300 font-bold" id="report-total-ratio">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Efficiency:</span>
                                <span class="text-white font-bold" id="report-efficiency">-</span>
                            </div>
                            <div class="flex justify-between border-t border-slate-700 pt-2 mt-2">
                                <span class="text-slate-400">Nominal Output Torque:</span>
                                <span class="text-amber-300 font-bold" id="report-gearbox-nominal">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Peak Output Torque:</span>
                                <span class="text-orange-300 font-bold" id="report-gearbox-peak">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Min. Recommended Peak:</span>
                                <span class="text-red-300 font-bold" id="report-gearbox-peak-min">-</span>
                            </div>
                            <div class="text-[10px] text-slate-500 italic mt-1">
                                *Per motor, with <span id="report-safety-factor">1.5</span>× safety factor for peak torque
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Summary -->
                <div class="bg-slate-800 rounded-lg p-4 border-l-4 border-purple-500">
                    <h3 class="text-sm font-bold text-purple-300 mb-3 uppercase">Performance Summary</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-400">Peak Torque Required:</span>
                            <span class="text-white font-bold" id="report-peak-torque">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Acceleration Time:</span>
                            <span class="text-white font-bold" id="report-accel-time">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Friction (Rolling):</span>
                            <span class="text-white font-bold" id="report-mu-rolling">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Friction (Static):</span>
                            <span class="text-white font-bold" id="report-mu-static">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- GLOBAL VARIABLES ---
        let scene, camera, renderer, controls;
        let turntableGroup, stageMesh, gridHelper;
        let motors = [];
        let actualStageRpm = 0; 
        let actualDriveRpm = 0; 
        let animationStageRpm = 0; // RPM for 3D animation (uses input value)
        let animationDriveRpm = 0; // Drive RPM for 3D animation
        let isReverseMode = false;
        let isGearDrive = false;
        let isLinearMode = false; // false = Turntable, true = Linear Track
        let wheelDiaUnit = 'mm'; // 'mm' | 'inch'
        let linearSpeedUnit = 'm/s'; // 'm/s' | 'm/min'
        
        // Physics Constants
        const g = 9.81;
        const mu_traction = 0.3;
        const STANDARD_MOTOR_KW = [0.37, 0.55, 0.75, 1.1, 1.5, 2.2, 3.0, 4.0, 5.5, 7.5, 11, 15, 18.5, 22, 30];
        function getStandardMotorKw(requiredKw) {
            const k = parseFloat(requiredKw) || 0;
            for (let i = 0; i < STANDARD_MOTOR_KW.length; i++) if (STANDARD_MOTOR_KW[i] >= k) return STANDARD_MOTOR_KW[i];
            return STANDARD_MOTOR_KW[STANDARD_MOTOR_KW.length - 1];
        }
        const STANDARD_VFD_KW = [0.75, 1.5, 2.2, 3.7, 5.5, 7.5, 11, 15, 18.5, 22, 30, 37, 45, 55, 75];
        function getStandardVfdKw(totalKw) {
            const k = parseFloat(totalKw) || 0;
            for (let i = 0; i < STANDARD_VFD_KW.length; i++) if (STANDARD_VFD_KW[i] >= k) return STANDARD_VFD_KW[i];
            return STANDARD_VFD_KW[STANDARD_VFD_KW.length - 1];
        }
        function typicalServoRotorInertiaKgM2(P_kw) {
            const p = Math.max(0.1, parseFloat(P_kw) || 0);
            return 0.00018 * Math.pow(p, 0.9);
        }

        const PROJECT_STORAGE_KEY = 'mechanicHobotProject';
        const PROJECT_INPUT_IDS = ['diameter','mass','inputPower','rpm','accelTime','decelTime','motors','wheelDia','teethTurntable','teethPinion','gearRatio','efficiency','safetyFactor','muRolling','muStatic','maxMotorRpm','motorType','motorPole','driveRadiusSlider','colorStage','colorBg','linearGearModule','linearGearTeeth','sCurveFactor'];
        function getProjectData() {
            const data = { version: '1.3', inputs: {} };
            PROJECT_INPUT_IDS.forEach(id => {
                const el = document.getElementById(id);
                if (el && (el.type === 'number' || el.type === 'text' || el.type === 'color')) data.inputs[id] = el.value;
                if (el && el.tagName === 'SELECT') data.inputs[id] = el.value;
            });
            data.linearGearPreset = (document.getElementById('linearGearPreset') || {}).value;
            data.driveType = (document.querySelector('input[name="driveType"]:checked') || {}).value || 'wheel';
            data.appMode = isLinearMode ? 'linear' : 'turntable';
            data.calcMode = isReverseMode ? 'load' : 'power';
            data.wheelDiaUnit = wheelDiaUnit;
            data.linearSpeedUnit = linearSpeedUnit;
            data.accelProfile = (document.querySelector('input[name="accelProfile"]:checked') || {}).value || 'linear';
            return data;
        }
        function autoSave() {
            try { localStorage.setItem(PROJECT_STORAGE_KEY, JSON.stringify(getProjectData())); } catch(e) {}
        }
        function saveProject() {
            try {
                const data = getProjectData();
                localStorage.setItem(PROJECT_STORAGE_KEY, JSON.stringify(data));
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'mechanic-hobot-project.json';
                a.click();
                URL.revokeObjectURL(a.href);
                return true;
            } catch (e) { return false; }
        }
        function applyProjectData(data) {
            if (!data || !data.inputs) return;
            Object.keys(data.inputs).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = data.inputs[id];
            });
            if (data.linearGearPreset && inputs.linearGearPreset) inputs.linearGearPreset.value = data.linearGearPreset;
            if (data.appMode) setAppMode(data.appMode === 'linear');
            if (data.driveType) setDriveType(data.driveType);
            if (data.calcMode) setMode(data.calcMode === 'load');
            if (data.wheelDiaUnit) setWheelDiaUnit(data.wheelDiaUnit);
            if (data.linearSpeedUnit) setLinearSpeedUnit(data.linearSpeedUnit);
            if (data.accelProfile) {
                const r = document.querySelector('input[name="accelProfile"][value="' + data.accelProfile + '"]');
                if (r) r.checked = true;
                if (typeof updateAccelProfileUI === 'function') updateAccelProfileUI();
            }
            updateSliderMax();
            if (inputs.driveRadiusVal) inputs.driveRadiusVal.textContent = inputs.driveRadiusSlider?.value ?? '';
            updateWheelDiaConversionBadge();
            updateLinearSpeedConvert();
            updateLinearGearPresetFromInputs();
            updateLinearGearPitchDiaDisplay();
            updateMotorTypeUI();
            updateColors();
            calculateAndRender();
        }
        function loadProject() {
            try {
                const raw = localStorage.getItem(PROJECT_STORAGE_KEY);
                if (!raw) return;
                applyProjectData(JSON.parse(raw));
            } catch (e) { console.warn('Load project failed', e); }
        }

        // --- DOM ELEMENTS ---
        const inputs = {
            diameter: document.getElementById('diameter'),
            mass: document.getElementById('mass'),
            inputPower: document.getElementById('inputPower'), 
            rpm: document.getElementById('rpm'),
            accelTime: document.getElementById('accelTime'),
            decelTime: document.getElementById('decelTime'),
            accelProfileRadios: document.getElementsByName('accelProfile'),
            sCurveFactor: document.getElementById('sCurveFactor'),
            sCurveFactorWrap: document.getElementById('s-curve-factor-wrap'),
            motors: document.getElementById('motors'),
            motorDec: document.getElementById('motorDec'), 
            motorInc: document.getElementById('motorInc'), 
            driveRadios: document.getElementsByName('driveType'),
            containerWheel: document.getElementById('drive-input-wheel'),
            containerGear: document.getElementById('drive-input-gear'),
            containerLinearGear: document.getElementById('drive-input-linear-gear'),
            linearGearPreset: document.getElementById('linearGearPreset'),
            linearGearModule: document.getElementById('linearGearModule'),
            linearGearTeeth: document.getElementById('linearGearTeeth'),
            wheelDia: document.getElementById('wheelDia'),
            wheelUnitMm: document.getElementById('wheelUnitMm'),
            wheelUnitInch: document.getElementById('wheelUnitInch'),
            wheelDiaConvert: document.getElementById('wheelDiaConvert'),
            teethTurntable: document.getElementById('teethTurntable'),
            teethPinion: document.getElementById('teethPinion'),
            gearRatio: document.getElementById('gearRatio'),
            efficiency: document.getElementById('efficiency'),
            safetyFactor: document.getElementById('safetyFactor'),
            muRolling: document.getElementById('muRolling'),
            muStatic: document.getElementById('muStatic'),
            maxMotorRpm: document.getElementById('maxMotorRpm'),
            motorType: document.getElementById('motorType'),
            motorPole: document.getElementById('motorPole'),
            motorPoleContainer: document.getElementById('motor-pole-container'),
            colorStage: document.getElementById('colorStage'),
            colorBg: document.getElementById('colorBg'),
            driveRadiusSlider: document.getElementById('driveRadiusSlider'),
            driveRadiusVal: document.getElementById('driveRadiusVal'),
            driveRadiusGearNote: document.getElementById('drive-radius-gear-note'),
            containerMass: document.getElementById('input-container-mass'),
            containerPower: document.getElementById('input-container-power'),
            btnNormal: document.getElementById('mode-normal'),
            btnReverse: document.getElementById('mode-reverse'),
            appModeTurntable: document.getElementById('app-mode-turntable'),
            appModeLinear: document.getElementById('app-mode-linear'),
            labelDiameter: document.getElementById('label-diameter'),
            labelRpm: document.getElementById('label-rpm'),
            linearSpeedUnitBtns: document.getElementById('linear-speed-unit-btns'),
            linearSpeedConvert: document.getElementById('linear-speed-convert'),
            linearSpeedMs: document.getElementById('linearSpeedMs'),
            linearSpeedMmin: document.getElementById('linearSpeedMmin'),
            driveRadiusSection: document.getElementById('drive-radius-section'),
            // UI
            tabInputs: document.getElementById('tab-inputs'),
            tabResults: document.getElementById('tab-results'),
            sidebarInputs: document.getElementById('sidebar-inputs'),
            sidebarResults: document.getElementById('sidebar-results'),
            btnHomeCam: document.getElementById('btn-home-cam'),
            // Friction Buttons
            btnFricClean: document.getElementById('btn-fric-clean'),
            btnFricDusty: document.getElementById('btn-fric-dusty'),
            // Report
            btnReport: document.getElementById('btn-report'),
            btnExportReport: document.getElementById('btn-export-report'),
            btnCloseReport: document.getElementById('btn-close-report'),
            reportModal: document.getElementById('report-modal'),
        };

        const outputs = {
            mainTitle: document.getElementById('main-result-title'),
            blockNormal: document.getElementById('res-block-normal'),
            blockReverse: document.getElementById('res-block-reverse'),
            motorRpm: document.getElementById('res-motor-rpm'),
            motorTorque: document.getElementById('res-motor-torque'),
            power: document.getElementById('res-power'),
            powerHp: document.getElementById('res-power-hp'),
            powerTotal: document.getElementById('res-power-total'),
            totalMotorsCount: document.getElementById('total-motors-count'),
            powerVA: document.getElementById('res-power-va'),
            current: document.getElementById('res-current'),
            
            // Reverse Mode Electrical Outputs
            powerTotalRev: document.getElementById('res-power-total-rev'),
            totalMotorsCountRev: document.getElementById('total-motors-count-rev'),
            powerVARev: document.getElementById('res-power-va-rev'),
            currentRev: document.getElementById('res-current-rev'),
            
            maxLoad: document.getElementById('res-max-load'),
            limitFactor: document.getElementById('res-limit-factor'),
            peakTorque: document.getElementById('res-peak-torque'),
            peakReason: document.getElementById('peak-reason'),
            torqueTitle: document.getElementById('torque-card-title'),
            peakTorqueLabel: document.getElementById('peak-torque-label'),
            tStatic: document.getElementById('res-t-static'),
            tFric: document.getElementById('res-t-fric'),
            tAccel: document.getElementById('res-t-accel'),
            brakeLabel: document.getElementById('res-brake-label'),
            brake: document.getElementById('res-brake'),
            forceWheel: document.getElementById('res-force-wheel'),
            wheelRpm: document.getElementById('res-wheel-rpm'),
            minWeight: document.getElementById('res-min-weight'),
            resDriveRad: document.getElementById('res-drive-rad'),
            tractionBox: document.getElementById('traction-warning'),
            rpmWarning: document.getElementById('rpm-warning'),
            warnTargetRpm: document.getElementById('warn-target-rpm'),
            warnActualRpm: document.getElementById('warn-actual-rpm'),
            animRpm: document.getElementById('anim-rpm'),
            viewDim: document.getElementById('view-dim'),
            viewDriveRad: document.getElementById('view-drive-rad'),
            lblForceOutput: document.getElementById('lbl-force-output'),
            lblSpeedOutput: document.getElementById('lbl-speed-output'),
            gearboxNominal: document.getElementById('res-gearbox-nominal'),
            gearboxPeak: document.getElementById('res-gearbox-peak'),
            gearboxPeakMin: document.getElementById('res-gearbox-peak-min'),
            resSafetyFactor: document.getElementById('res-safety-factor'),
            motorRatedTorque: document.getElementById('res-motor-rated-torque')
        };

        // --- INITIALIZATION ---
        function init() {
            const container = document.getElementById('canvas-container');
            document.getElementById('loading').remove();

            setupScene(container);
            window.addEventListener('resize', onWindowResize);
            
            try {
                const data = JSON.parse(localStorage.getItem(PROJECT_STORAGE_KEY));
                if (data) applyProjectData(data);
            } catch (e) {}

            // Inputs Event Listeners
            Object.values(inputs).forEach(input => {
                if(input instanceof HTMLElement && ['input', 'select'].includes(input.tagName.toLowerCase())) {
                    input.addEventListener('input', (e) => {
                        // Special handling for motor type/pole changes
                        if (e.target.id === 'motorType' || e.target.id === 'motorPole') {
                            updateMotorTypeUI();
                        }
                        if (e.target.id === 'wheelDia') updateWheelDiaConversionBadge();
                        if (e.target.id === 'rpm' && isLinearMode && typeof updateLinearSpeedConvert === 'function') updateLinearSpeedConvert();
                        handleInput(e.target.id);
                        calculateAndRender();
                        updateColors();
                    });
                }
            });

            // Radio Buttons
            inputs.driveRadios.forEach(radio => {
                radio.addEventListener('change', (e) => setDriveType(e.target.value));
            });

            // Motor Buttons
            inputs.motorDec.addEventListener('click', () => {
                let val = parseInt(inputs.motors.value) || 0;
                if (val > 1) {
                    inputs.motors.value = val - 1;
                    inputs.motors.dispatchEvent(new Event('input'));
                }
            });
            inputs.motorInc.addEventListener('click', () => {
                let val = parseInt(inputs.motors.value) || 0;
                inputs.motors.value = val + 1;
                inputs.motors.dispatchEvent(new Event('input'));
            });

            // Save/Load/Import Project
            const btnSave = document.getElementById('btn-save-project');
            const inputImport = document.getElementById('input-import-project');
            if (btnSave) btnSave.addEventListener('click', () => { if (saveProject()) btnSave.textContent = ' Saved!'; setTimeout(() => { if (btnSave) btnSave.innerHTML = '<i class="fa-solid fa-floppy-disk mr-1"></i> Save File'; }, 1500); });
            if (inputImport) inputImport.addEventListener('change', function() {
                const f = this.files && this.files[0];
                if (!f) return;
                const r = new FileReader();
                r.onload = () => { try { applyProjectData(JSON.parse(r.result)); } catch (e) { console.warn(e); } inputImport.value = ''; };
                r.readAsText(f);
            });

            // Application mode (Turntable / Linear Track)
            if (inputs.appModeTurntable) inputs.appModeTurntable.addEventListener('click', () => setAppMode(false));
            if (inputs.appModeLinear) inputs.appModeLinear.addEventListener('click', () => setAppMode(true));
            // Calc modes
            inputs.btnNormal.addEventListener('click', () => setMode(false));
            inputs.btnReverse.addEventListener('click', () => setMode(true));

            // Tabs (Mobile)
            inputs.tabInputs.addEventListener('click', () => switchTab('inputs'));
            inputs.tabResults.addEventListener('click', () => switchTab('results'));

            // Camera Reset
            inputs.btnHomeCam.addEventListener('click', resetCamera);

            // Friction Buttons
            inputs.btnFricClean.addEventListener('click', () => {
                inputs.muRolling.value = 0.02;
                inputs.muStatic.value = 0.05;
                inputs.muRolling.dispatchEvent(new Event('input')); // Trigger update
            });
            inputs.btnFricDusty.addEventListener('click', () => {
                inputs.muRolling.value = 0.04; // 2x Standard (0.02 * 2)
                inputs.muStatic.value = 0.10;  // 2x Standard (0.05 * 2)
                inputs.muRolling.dispatchEvent(new Event('input'));
            });

            // Report Button
            if (inputs.btnReport) {
                inputs.btnReport.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Report button clicked');
                    generateReport();
                    const modal = document.getElementById('report-modal');
                    if (modal) {
                        modal.classList.remove('hidden');
                        console.log('Modal opened');
                    } else {
                        console.error('Report modal element not found!');
                        alert('Report modal not found. Please refresh the page.');
                    }
                });
            } else {
                console.error('Report button not found!');
            }
            
            const closeBtn = document.getElementById('btn-close-report');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    const modal = document.getElementById('report-modal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                });
            }
            
            const modal = document.getElementById('report-modal');
            if (modal) {
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            }

            if (inputs.btnExportReport) {
                inputs.btnExportReport.addEventListener('click', () => {
                    try { exportPDF(); } catch(e) { console.error('Export error:', e); alert('Export failed: ' + e.message); }
                });
            }

            // Wheel diameter unit toggle
            if (inputs.wheelUnitMm) inputs.wheelUnitMm.addEventListener('click', () => setWheelDiaUnit('mm'));
            if (inputs.wheelUnitInch) inputs.wheelUnitInch.addEventListener('click', () => setWheelDiaUnit('inch'));
            updateWheelDiaConversionBadge();

            // Linear speed unit (m/s | m/min)
            if (inputs.linearSpeedMs) inputs.linearSpeedMs.addEventListener('click', () => setLinearSpeedUnit('m/s'));
            if (inputs.linearSpeedMmin) inputs.linearSpeedMmin.addEventListener('click', () => setLinearSpeedUnit('m/min'));

            // Acceleration profile (Linear / S-Curve)
            function updateAccelProfileUI() {
                const checked = document.querySelector('input[name="accelProfile"]:checked');
                if (inputs.sCurveFactorWrap) inputs.sCurveFactorWrap.classList.toggle('hidden', !checked || checked.value !== 's-curve');
            }
            if (inputs.accelProfileRadios && inputs.accelProfileRadios.length) {
                Array.from(inputs.accelProfileRadios).forEach(r => r.addEventListener('change', () => { updateAccelProfileUI(); calculateAndRender(); }));
            }
            updateAccelProfileUI();

            // Linear gear: preset dropdown and Module/Teeth (Custom when manual)
            if (inputs.linearGearPreset) {
                inputs.linearGearPreset.addEventListener('change', () => {
                    const v = inputs.linearGearPreset.value;
                    if (v === 'custom') return;
                    const parts = v.split('-');
                    if (parts.length === 2 && inputs.linearGearModule && inputs.linearGearTeeth) {
                        inputs.linearGearModule.value = parts[0];
                        inputs.linearGearTeeth.value = parts[1];
                        updateLinearGearPitchDiaDisplay();
                    }
                    calculateAndRender();
                });
            }
            if (inputs.linearGearModule) {
                inputs.linearGearModule.addEventListener('input', () => {
                    updateLinearGearPresetFromInputs();
                    updateLinearGearPitchDiaDisplay();
                });
            }
            if (inputs.linearGearTeeth) {
                inputs.linearGearTeeth.addEventListener('input', () => {
                    updateLinearGearPresetFromInputs();
                    updateLinearGearPitchDiaDisplay();
                });
            }
            updateLinearGearPresetFromInputs();
            updateLinearGearPitchDiaDisplay();

            // Defaults
            updateSliderMax();
            updateMotorTypeUI();
            setDriveType('wheel'); 
            calculateAndRender();
            animate();
        }

        function setupScene(container) {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(inputs.colorBg.value); 
            scene.fog = new THREE.Fog(inputs.colorBg.value, 20, 100);

            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            resetCamera(); // Set initial position

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.maxPolarAngle = Math.PI / 2 - 0.05;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            scene.add(dirLight);

            gridHelper = new THREE.GridHelper(100, 100, 0x334155, 0x1e293b);
            scene.add(gridHelper);

            turntableGroup = new THREE.Group();
            scene.add(turntableGroup);
        }

        function resetCamera() {
            if(camera && controls) {
                camera.position.set(25, 20, 25);
                controls.target.set(0, 0, 0);
                controls.update();
            } else if (camera) {
                camera.position.set(25, 20, 25);
            }
        }

        function switchTab(tab) {
            if(tab === 'inputs') {
                inputs.sidebarInputs.classList.remove('hidden');
                inputs.sidebarResults.classList.add('hidden');
                inputs.tabInputs.classList.add('tab-active');
                inputs.tabInputs.classList.remove('tab-inactive');
                inputs.tabResults.classList.remove('tab-active');
                inputs.tabResults.classList.add('tab-inactive');
            } else {
                inputs.sidebarInputs.classList.add('hidden');
                inputs.sidebarResults.classList.remove('hidden');
                inputs.tabResults.classList.add('tab-active');
                inputs.tabResults.classList.remove('tab-inactive');
                inputs.tabInputs.classList.remove('tab-active');
                inputs.tabInputs.classList.add('tab-inactive');
            }
        }

        function setDriveType(type) {
            isGearDrive = (type === 'gear');
            const labelWheel = document.getElementById('label-wheel-or-pinion');
            
            if (isGearDrive) {
                if (isLinearMode) {
                    // Linear + Gear: rack & pinion — Module + Teeth (standard dropdown or Custom)
                    inputs.containerWheel.classList.add('hidden');
                    inputs.containerGear.classList.add('hidden');
                    inputs.containerGear.classList.remove('flex');
                    if (inputs.containerLinearGear) inputs.containerLinearGear.classList.remove('hidden');
                    if (labelWheel) labelWheel.textContent = 'Drive Wheel Diameter';
                } else {
                    inputs.containerWheel.classList.add('hidden');
                    inputs.containerGear.classList.remove('hidden');
                    inputs.containerGear.classList.add('flex');
                    if (inputs.containerLinearGear) inputs.containerLinearGear.classList.add('hidden');
                    if (labelWheel) labelWheel.textContent = 'Drive Wheel Diameter';
                }
                if (inputs.driveRadiusGearNote) inputs.driveRadiusGearNote.classList.remove('hidden');
                outputs.lblForceOutput.innerText = "Tangential Force (At Pinion)";
                outputs.lblSpeedOutput.innerText = "Pinion Speed";
                outputs.tractionBox.classList.add('hidden'); 
            } else {
                inputs.containerWheel.classList.remove('hidden');
                inputs.containerGear.classList.add('hidden');
                inputs.containerGear.classList.remove('flex');
                if (inputs.containerLinearGear) inputs.containerLinearGear.classList.add('hidden');
                if (inputs.driveRadiusGearNote) inputs.driveRadiusGearNote.classList.add('hidden');
                if (labelWheel) labelWheel.textContent = 'Drive Wheel Diameter';
                outputs.lblForceOutput.innerText = "Tangential Force (Per Wheel)";
                outputs.lblSpeedOutput.innerText = "Wheel Speed";
            }
            calculateAndRender();
        }

        function setAppMode(linear) {
            isLinearMode = linear;
            if (linear) {
                if (inputs.appModeTurntable) { inputs.appModeTurntable.classList.remove('bg-blue-600', 'text-white'); inputs.appModeTurntable.classList.add('text-slate-400'); }
                if (inputs.appModeLinear) { inputs.appModeLinear.classList.add('bg-blue-600', 'text-white'); inputs.appModeLinear.classList.remove('text-slate-400'); }
                if (inputs.labelDiameter) inputs.labelDiameter.textContent = 'Track Length (m)';
                if (inputs.labelRpm) inputs.labelRpm.textContent = 'Target Speed (m/s)';
                if (inputs.driveRadiusSection) inputs.driveRadiusSection.classList.add('hidden');
                if (inputs.linearSpeedUnitBtns) inputs.linearSpeedUnitBtns.classList.remove('hidden');
                if (inputs.linearSpeedConvert) { inputs.linearSpeedConvert.classList.remove('hidden'); updateLinearSpeedConvert(); }
                if (inputs.rpm && parseFloat(inputs.rpm.value) < 0.1) inputs.rpm.value = 0.5; // sensible default for m/s
                linearSpeedUnit = 'm/s';
                if (inputs.linearSpeedMs) inputs.linearSpeedMs.classList.add('bg-blue-600', 'text-white');
                if (inputs.linearSpeedMmin) { inputs.linearSpeedMmin.classList.remove('bg-blue-600', 'text-white'); inputs.linearSpeedMmin.classList.add('text-slate-400'); }
                if (isGearDrive) {
                    inputs.containerWheel.classList.add('hidden');
                    inputs.containerGear.classList.add('hidden');
                    inputs.containerGear.classList.remove('flex');
                    if (inputs.containerLinearGear) inputs.containerLinearGear.classList.remove('hidden');
                }
            } else {
                if (inputs.appModeTurntable) { inputs.appModeTurntable.classList.add('bg-blue-600', 'text-white'); inputs.appModeTurntable.classList.remove('text-slate-400'); }
                if (inputs.appModeLinear) { inputs.appModeLinear.classList.remove('bg-blue-600', 'text-white'); inputs.appModeLinear.classList.add('text-slate-400'); }
                if (inputs.labelDiameter) inputs.labelDiameter.textContent = 'Turntable Diameter (m)';
                if (inputs.labelRpm) inputs.labelRpm.textContent = 'Target Speed (RPM)';
                if (inputs.driveRadiusSection) inputs.driveRadiusSection.classList.remove('hidden');
                if (inputs.linearSpeedUnitBtns) inputs.linearSpeedUnitBtns.classList.add('hidden');
                if (inputs.linearSpeedConvert) inputs.linearSpeedConvert.classList.add('hidden');
                if (inputs.rpm && parseFloat(inputs.rpm.value) < 2) inputs.rpm.value = 1; // was m/s, restore RPM default
                if (isGearDrive) {
                    inputs.containerWheel.classList.add('hidden');
                    inputs.containerGear.classList.remove('hidden');
                    inputs.containerGear.classList.add('flex');
                    if (inputs.containerLinearGear) inputs.containerLinearGear.classList.add('hidden');
                }
            }
            calculateAndRender();
        }

        function setMode(reverse) {
            isReverseMode = reverse;
            if (reverse) {
                inputs.btnReverse.classList.replace('bg-slate-800', 'bg-emerald-600');
                inputs.btnReverse.classList.replace('text-slate-400', 'text-white');
                inputs.btnNormal.classList.replace('bg-emerald-600', 'bg-slate-800');
                inputs.btnNormal.classList.replace('text-white', 'text-slate-400');

                inputs.containerMass.classList.add('hidden');
                inputs.containerPower.classList.remove('hidden');
                outputs.mainTitle.innerHTML = '<i class="fa-solid fa-weight-hanging"></i> Capacity Calculation';
                outputs.blockNormal.classList.add('hidden');
                outputs.blockReverse.classList.remove('hidden');
                outputs.torqueTitle.innerText = "Available Torque vs Load";
                outputs.peakTorqueLabel.innerText = "Max Available Torque";
            } else {
                inputs.btnNormal.classList.replace('bg-slate-800', 'bg-emerald-600');
                inputs.btnNormal.classList.replace('text-slate-400', 'text-white');
                inputs.btnReverse.classList.replace('bg-emerald-600', 'bg-slate-800');
                inputs.btnReverse.classList.replace('text-white', 'text-slate-400');

                inputs.containerPower.classList.add('hidden');
                inputs.containerMass.classList.remove('hidden');
                outputs.mainTitle.innerHTML = '<i class="fa-solid fa-clipboard-check"></i> Recommended Motor Spec';
                outputs.blockReverse.classList.add('hidden');
                outputs.blockNormal.classList.remove('hidden');
                outputs.torqueTitle.innerText = "Stage Torque Analysis";
                outputs.peakTorqueLabel.innerText = "Design Peak Torque (with SF)";
            }
            calculateAndRender();
        }

        function handleInput(id) {
            if (id === 'diameter') updateSliderMax();
            if (id === 'driveRadiusSlider') inputs.driveRadiusVal.innerText = inputs.driveRadiusSlider.value;
            // Removed direct updateMotorTypeUI call from here as it's now handled in the event listener with correct ordering
        }

        function updateSliderMax() {
            const R_stage = parseFloat(inputs.diameter.value) / 2;
            const currentVal = parseFloat(inputs.driveRadiusSlider.value);
            inputs.driveRadiusSlider.max = R_stage;
            if(currentVal > R_stage) {
                inputs.driveRadiusSlider.value = R_stage - 0.5;
                inputs.driveRadiusVal.innerText = inputs.driveRadiusSlider.value;
            }
        }

        function updateMotorTypeUI() {
            if (!inputs.motorType || !inputs.motorPoleContainer) return;
            if (inputs.motorType.value === 'induction') {
                inputs.motorPoleContainer.classList.remove('hidden');
                // Keep RPM editable; auto-set from pole when pole changes, user can override
                inputs.maxMotorRpm.disabled = false;
                inputs.maxMotorRpm.classList.remove('opacity-50', 'cursor-not-allowed');
                inputs.maxMotorRpm.value = getRatedMotorRpm();
            } else {
                inputs.motorPoleContainer.classList.add('hidden');
                inputs.maxMotorRpm.disabled = false;
                inputs.maxMotorRpm.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function getRatedMotorRpm() {
            if (!inputs.motorType) return parseFloat(inputs.maxMotorRpm.value);
            if (inputs.motorType.value !== 'induction') {
                return parseFloat(inputs.maxMotorRpm.value);
            }
            const poles = parseInt(inputs.motorPole.value || '4', 10);
            const gridFrequencyHz = 50;
            // Use standard slip ~3% for calculation
            const slipFactor = 0.97; 
            const syncRpm = (120 * gridFrequencyHz) / poles;
            return Math.round(syncRpm * slipFactor);
        }

        function getWheelDiaMm() {
            const v = parseFloat(inputs.wheelDia.value) || 0;
            return wheelDiaUnit === 'inch' ? v * 25.4 : v;
        }

        function getLinearSpeedMs() {
            const v = parseFloat(inputs.rpm.value) || 0;
            return linearSpeedUnit === 'm/min' ? v / 60 : v;
        }

        function updateLinearSpeedConvert() {
            if (!inputs.linearSpeedConvert) return;
            const v = parseFloat(inputs.rpm.value) || 0;
            if (linearSpeedUnit === 'm/s') {
                inputs.linearSpeedConvert.textContent = '≈ ' + (v * 60).toFixed(1) + ' m/min';
            } else {
                inputs.linearSpeedConvert.textContent = '≈ ' + (v / 60).toFixed(3) + ' m/s';
            }
        }

        function setLinearSpeedUnit(unit) {
            linearSpeedUnit = unit;
            const ms = getLinearSpeedMs();
            if (unit === 'm/min') {
                inputs.rpm.value = (ms * 60).toFixed(2);
                if (inputs.linearSpeedMs) { inputs.linearSpeedMs.classList.remove('bg-blue-600', 'text-white'); inputs.linearSpeedMs.classList.add('text-slate-400'); }
                if (inputs.linearSpeedMmin) { inputs.linearSpeedMmin.classList.add('bg-blue-600', 'text-white'); inputs.linearSpeedMmin.classList.remove('text-slate-400'); }
            } else {
                inputs.rpm.value = ms <= 0.1 ? ms.toFixed(3) : ms.toFixed(2);
                if (inputs.linearSpeedMs) { inputs.linearSpeedMs.classList.add('bg-blue-600', 'text-white'); inputs.linearSpeedMs.classList.remove('text-slate-400'); }
                if (inputs.linearSpeedMmin) { inputs.linearSpeedMmin.classList.remove('bg-blue-600', 'text-white'); inputs.linearSpeedMmin.classList.add('text-slate-400'); }
            }
            updateLinearSpeedConvert();
        }

        function getLinearGearPitchDiaMm() {
            if (!inputs.linearGearModule || !inputs.linearGearTeeth) return 40;
            const m = parseFloat(inputs.linearGearModule.value) || 2;
            const z = parseInt(inputs.linearGearTeeth.value, 10) || 20;
            return m * z;
        }

        function updateLinearGearPresetFromInputs() {
            if (!inputs.linearGearPreset) return;
            const m = parseFloat(inputs.linearGearModule?.value) || 2;
            const z = parseInt(inputs.linearGearTeeth?.value, 10) || 20;
            const val = m + '-' + z;
            const opt = Array.from(inputs.linearGearPreset.options).find(o => o.value === val);
            inputs.linearGearPreset.value = opt ? opt.value : 'custom';
        }

        function updateLinearGearPitchDiaDisplay() {
            const el = document.getElementById('linearGearPitchDia');
            if (el) el.textContent = getLinearGearPitchDiaMm();
        }

        function updateWheelDiaConversionBadge() {
            if (!inputs.wheelDiaConvert) return;
            const mm = getWheelDiaMm();
            if (wheelDiaUnit === 'mm') {
                inputs.wheelDiaConvert.textContent = '≈ ' + (mm / 25.4).toFixed(2) + ' in';
            } else {
                inputs.wheelDiaConvert.textContent = '≈ ' + mm.toFixed(1) + ' mm';
            }
        }

        function setWheelDiaUnit(unit) {
            wheelDiaUnit = unit;
            const mm = getWheelDiaMm();
            if (unit === 'inch') {
                inputs.wheelDia.value = (mm / 25.4).toFixed(2);
                inputs.wheelDia.step = '0.01';
                if (inputs.wheelUnitMm) { inputs.wheelUnitMm.className = 'px-2.5 py-1.5 text-xs font-medium text-slate-400 hover:bg-slate-700 border-r border-slate-600'; inputs.wheelUnitMm.classList.remove('bg-blue-600', 'text-white'); }
                if (inputs.wheelUnitInch) { inputs.wheelUnitInch.className = 'px-2.5 py-1.5 text-xs font-medium bg-blue-600 text-white'; inputs.wheelUnitInch.classList.remove('text-slate-400'); }
            } else {
                inputs.wheelDia.value = Math.round(mm);
                inputs.wheelDia.step = '1';
                if (inputs.wheelUnitMm) { inputs.wheelUnitMm.className = 'px-2.5 py-1.5 text-xs font-medium bg-blue-600 text-white border-r border-slate-600'; inputs.wheelUnitMm.classList.remove('text-slate-400'); }
                if (inputs.wheelUnitInch) { inputs.wheelUnitInch.className = 'px-2.5 py-1.5 text-xs font-medium text-slate-400 hover:bg-slate-700 border-r border-slate-600'; inputs.wheelUnitInch.classList.remove('bg-blue-600', 'text-white'); }
            }
            updateWheelDiaConversionBadge();
        }

        function updateColors() {
            if (scene) {
                const bgColor = new THREE.Color(inputs.colorBg.value);
                scene.background = bgColor;
                scene.fog.color = bgColor;
            }
            if (stageMesh) {
                stageMesh.material.color.set(inputs.colorStage.value);
            }
        }

        // --- MAIN LOGIC ---
        function calculateAndRender() {
            const D = parseFloat(inputs.diameter.value);
            const rpm_stage_target = parseFloat(inputs.rpm.value);
            const t_accel = parseFloat(inputs.accelTime.value);
            const t_decel = Math.max(0.5, parseFloat(inputs.decelTime?.value) || 15);
            const num_motors = parseInt(inputs.motors.value);
            const gear_ratio = parseFloat(inputs.gearRatio.value);
            const eta = parseFloat(inputs.efficiency.value);
            const safety_factor = Math.max(1, Math.min(3, parseFloat(inputs.safetyFactor?.value) || 1.5));
            const accel_profile = (document.querySelector('input[name="accelProfile"]:checked') || {}).value || 'linear';
            const s_curve_factor = accel_profile === 's-curve' ? Math.max(1.1, Math.min(2.5, parseFloat(inputs.sCurveFactor?.value) || 1.5)) : 1;
            const mu_rolling = parseFloat(inputs.muRolling.value);
            const mu_static = parseFloat(inputs.muStatic.value);
            const max_motor_rpm = parseFloat(inputs.maxMotorRpm.value);
            
            const R_stage = D / 2;
            const R_drive = isLinearMode ? 0 : parseFloat(inputs.driveRadiusSlider.value);
            
            let ratio_stage_to_drive = 0; 
            let drive_element_rpm = 0; 
            let rpm_motor_req = 0;
            let r_drive_element = 0;
            let alpha = 0;
            let T_rolling = 0, T_accel = 0, T_static = 0, T_dynamic_total = 0, T_peak_required = 0, peak_reason = '';
            let T_brake = 0, F_brake = 0;
            let F_drive_total_peak = 0, F_per_motor_peak = 0, T_drive_element_peak = 0;
            let F_drive_total_nominal = 0, F_per_motor_nominal = 0, T_drive_element_nominal = 0, T_motor_req = 0;

            if (isLinearMode) {
                // Linear track: speed in m/s, force-based (input may be m/s or m/min)
                const v_linear_ms = getLinearSpeedMs();
                const m_tons = parseFloat(inputs.mass.value);
                const m_kg = m_tons * 1000;
                const a_linear = t_accel > 0 ? v_linear_ms / t_accel : 0;
                const F_rolling_lin = mu_rolling * m_kg * g;
                const F_accel_lin = m_kg * a_linear;
                const F_accel_lin_eff = F_accel_lin * s_curve_factor;
                const F_static_lin = mu_static * m_kg * g;
                const F_peak_lin = Math.max(F_static_lin, F_rolling_lin + F_accel_lin_eff);
                if (isGearDrive && inputs.linearGearModule && inputs.linearGearTeeth) {
                    const pitchDiaMm = getLinearGearPitchDiaMm();
                    r_drive_element = (pitchDiaMm / 1000) / 2;
                } else {
                    const wheel_mm = getWheelDiaMm();
                    r_drive_element = (wheel_mm / 1000) / 2;
                }
                if (r_drive_element <= 0) r_drive_element = 0.02;
                if (isGearDrive) updateLinearGearPitchDiaDisplay();
                drive_element_rpm = (v_linear_ms / (2 * Math.PI * r_drive_element)) * 60;
                ratio_stage_to_drive = 0;
                rpm_motor_req = drive_element_rpm * gear_ratio;
                alpha = 0;
                T_rolling = F_rolling_lin;
                T_accel = F_accel_lin_eff;
                T_static = F_static_lin;
                T_dynamic_total = F_rolling_lin + F_accel_lin_eff;
                peak_reason = F_static_lin > (F_rolling_lin + F_accel_lin_eff) ? "Reason: Static Breakaway" : "Reason: Accel + Rolling";
                F_drive_total_peak = F_peak_lin;
                F_per_motor_peak = F_peak_lin / num_motors;
                T_drive_element_peak = F_per_motor_peak * r_drive_element;
                T_peak_required = T_drive_element_peak;
                F_drive_total_nominal = F_rolling_lin + F_accel_lin_eff;
                F_per_motor_nominal = F_drive_total_nominal / num_motors;
                T_drive_element_nominal = F_per_motor_nominal * r_drive_element;
                T_motor_req = T_drive_element_nominal / (gear_ratio * eta);
                const a_brake_lin = t_decel > 0 ? v_linear_ms / t_decel : 0;
                F_brake = m_kg * a_brake_lin;
            } else {
                if (isGearDrive) {
                    const teethT = parseInt(inputs.teethTurntable.value);
                    const teethP = parseInt(inputs.teethPinion.value);
                    ratio_stage_to_drive = teethT / teethP; 
                    drive_element_rpm = rpm_stage_target * ratio_stage_to_drive;
                    r_drive_element = R_drive / ratio_stage_to_drive;
                } else {
                    const wheel_mm = getWheelDiaMm();
                    const r_wheel = (wheel_mm / 1000) / 2;
                    r_drive_element = r_wheel;
                    const V_linear = (rpm_stage_target * 2 * Math.PI / 60) * R_drive;
                    const omega_wheel = V_linear / r_wheel;
                    drive_element_rpm = omega_wheel * 60 / (2 * Math.PI);
                    ratio_stage_to_drive = drive_element_rpm / rpm_stage_target;
                }
                rpm_motor_req = drive_element_rpm * gear_ratio;
            }

            let rpm_motor_effective = rpm_motor_req;
            let omega_stage_effective = isLinearMode ? 0 : (rpm_stage_target * 2 * Math.PI / 60);
            let is_limited = false;

            if (rpm_motor_req > max_motor_rpm) {
                is_limited = true;
                rpm_motor_effective = max_motor_rpm;
                const drive_rpm_eff = rpm_motor_effective / gear_ratio;
                if (isLinearMode) {
                    const v_eff_ms = (drive_rpm_eff * 2 * Math.PI / 60) * r_drive_element;
                    actualStageRpm = v_eff_ms;
                } else {
                    const stage_rpm_eff = drive_rpm_eff / ratio_stage_to_drive;
                    omega_stage_effective = stage_rpm_eff * 2 * Math.PI / 60;
                    actualStageRpm = omega_stage_effective * 60 / (2 * Math.PI);
                }
            } else {
                actualStageRpm = isLinearMode ? getLinearSpeedMs() : (omega_stage_effective * 60 / (2 * Math.PI));
            }

            if (!isLinearMode) alpha = omega_stage_effective / t_accel;
            const drive_element_rpm_final = rpm_motor_effective / gear_ratio;
            actualDriveRpm = drive_element_rpm_final;

            if (!isReverseMode && !isLinearMode) {
                const m_tons = parseFloat(inputs.mass.value);
                const m_kg = m_tons * 1000;
                T_rolling = mu_rolling * m_kg * g * R_stage;
                const I = 0.5 * m_kg * Math.pow(R_stage, 2);
                T_accel = I * alpha * s_curve_factor;
                T_static = mu_static * m_kg * g * R_stage;
                T_dynamic_total = T_rolling + T_accel;
                if (T_static > T_dynamic_total) {
                    T_peak_required = T_static;
                    peak_reason = "Reason: Static Breakaway > Accel";
                } else {
                    T_peak_required = T_dynamic_total;
                    peak_reason = "Reason: Accel + Rolling > Static";
                }
                F_drive_total_peak = T_peak_required / R_drive;
                F_per_motor_peak = F_drive_total_peak / num_motors;
                T_drive_element_peak = F_per_motor_peak * r_drive_element;
                F_drive_total_nominal = T_dynamic_total / R_drive;
                F_per_motor_nominal = F_drive_total_nominal / num_motors;
                T_drive_element_nominal = F_per_motor_nominal * r_drive_element;
                T_motor_req = T_drive_element_nominal / (gear_ratio * eta);
                const alpha_brake = t_decel > 0 ? omega_stage_effective / t_decel : 0;
                T_brake = I * alpha_brake;
            }

            if (!isReverseMode) {
                
                // Calculate Gearbox Output Torque
                // Nominal: Torque at operating condition (continuous)
                const T_gearbox_nominal = T_drive_element_nominal;
                // Peak: Torque at peak condition (startup / breakaway)
                const T_gearbox_peak = T_drive_element_peak;
                const T_gearbox_peak_min = T_gearbox_peak * safety_factor;
                
                // Calculate motor angular velocity at operating speed
                const omega_motor = rpm_motor_effective * 2 * Math.PI / 60;
                
                // Calculate rated power required (at rated RPM)
                // Motor characteristic: Constant torque below rated RPM, constant power above
                const omega_rated = max_motor_rpm * 2 * Math.PI / 60;
                let P_rated_required = 0;
                let P_operating = 0;
                
                if (rpm_motor_effective <= max_motor_rpm) {
                    // Operating below rated RPM: Need constant torque capability
                    // Required rated torque = T_motor_req (since torque is constant below rated RPM)
                    // Required rated power = T_rated × ω_rated
                    P_rated_required = (T_motor_req * omega_rated) / 1000;
                    P_operating = (T_motor_req * omega_motor) / 1000;
                } else {
                    // Operating above rated RPM: Need constant power capability
                    // Required rated power = P_required_at_speed (since power is constant above rated RPM)
                    P_operating = (T_motor_req * omega_motor) / 1000;
                    P_rated_required = P_operating;
                }
                
                // Display rated power (what motor must be rated for)
                const P_display = P_rated_required;
                
                // Calculate TOTAL power requirement for building/facility
                const P_total_kw = P_display * num_motors; // Total power for all motors
                
                // Calculate VA and Current for TOTAL system (3-phase 380V)
                // For building power assessment - calculate from TOTAL power
                const power_factor = 0.85; // Typical for induction motors
                const V_line = 380; // Line voltage (V)
                const P_total_va = P_total_kw / power_factor; // Total Apparent power in kVA
                const I_total_current = (P_total_kw * 1000) / (Math.sqrt(3) * V_line * power_factor * eta); // Total Current per phase in A
                
                // Per motor values (for reference)
                const P_va_per_motor = P_display / power_factor;
                const I_current_per_motor = (P_display * 1000) / (Math.sqrt(3) * V_line * power_factor * eta);

                if(!isGearDrive) {
                    // Use peak force for traction check (worst case)
                    const F_down_req_N = F_per_motor_peak / mu_traction;
                    const F_down_req_Tons = F_down_req_N / g / 1000;
                    outputs.minWeight.innerText = F_down_req_Tons.toFixed(2);
                    checkTraction(F_down_req_Tons);
                } else {
                    outputs.tractionBox.classList.add('hidden');
                }

                outputs.motorRpm.innerText = Math.round(rpm_motor_effective).toLocaleString();
                outputs.motorTorque.innerText = T_motor_req.toFixed(2);
                outputs.power.innerText = P_display.toFixed(2);
                if (outputs.powerHp) outputs.powerHp.textContent = '(' + (P_display * 1.34102).toFixed(2) + ' hp)';
                const resStandardMotor = document.getElementById('res-standard-motor');
                if (resStandardMotor) resStandardMotor.textContent = getStandardMotorKw(P_display);
                const vfdKw = getStandardVfdKw(P_total_kw);
                const resVfd = document.getElementById('res-vfd');
                const resVfdCurrent = document.getElementById('res-vfd-current');
                if (resVfd) resVfd.textContent = vfdKw;
                if (resVfdCurrent) resVfdCurrent.textContent = Math.ceil(I_total_current).toLocaleString() + ' A rated';
                outputs.powerTotal.innerText = P_total_kw.toFixed(2);
                outputs.totalMotorsCount.textContent = num_motors;
                if (inputs.motorType && inputs.motorType.value === 'servo') {
                    const m_kg_in = parseFloat(inputs.mass.value) * 1000;
                    const J_load = isLinearMode ? m_kg_in * r_drive_element * r_drive_element : 0.5 * m_kg_in * R_stage * R_stage;
                    const total_ratio_sq = isLinearMode ? (gear_ratio * gear_ratio) : (gear_ratio * ratio_stage_to_drive) * (gear_ratio * ratio_stage_to_drive);
                    const J_reflected = total_ratio_sq > 0 ? J_load / total_ratio_sq : 0;
                    const J_motor = typicalServoRotorInertiaKgM2(P_display);
                    const inertiaRatio = J_motor > 0 ? (J_reflected / J_motor) : 0;
                    const card = document.getElementById('inertia-ratio-card');
                    const ratioEl = document.getElementById('res-inertia-ratio');
                    const warnEl = document.getElementById('inertia-ratio-warning');
                    if (card) card.classList.remove('hidden');
                    if (ratioEl) { ratioEl.textContent = inertiaRatio.toFixed(1) + ':1'; ratioEl.className = inertiaRatio > 10 ? 'result-value text-amber-400' : 'result-value text-slate-200'; }
                    if (warnEl) warnEl.classList.toggle('hidden', inertiaRatio <= 10);
                } else {
                    const card = document.getElementById('inertia-ratio-card');
                    if (card) card.classList.add('hidden');
                }
                // Display TOTAL values for building power assessment
                outputs.powerVA.innerText = P_total_va.toFixed(2);
                outputs.current.innerText = I_total_current.toFixed(2);
                
                // Store values for report (both per motor and total)
                window.currentMotorRpm = rpm_motor_effective;
                window.currentMotorPower = P_display;
                window.currentMotorPowerTotal = P_total_kw;
                window.currentMotorVA = P_total_va; // Total VA
                window.currentMotorCurrent = I_total_current; // Total Current
                window.currentMotorVAPerMotor = P_va_per_motor;
                window.currentMotorCurrentPerMotor = I_current_per_motor;
                
                // Update additional display elements if they exist
                const torqueRpmEl = document.getElementById('torque-rpm');
                const ratedRpmEl = document.getElementById('rated-rpm-display');
                const powerNoteEl = document.getElementById('power-torque-note');
                
                if (torqueRpmEl) torqueRpmEl.textContent = Math.round(rpm_motor_effective).toLocaleString();
                if (ratedRpmEl) ratedRpmEl.textContent = Math.round(max_motor_rpm).toLocaleString();
                
                if (powerNoteEl) {
                    if (rpm_motor_effective <= max_motor_rpm) {
                        powerNoteEl.textContent = `Rated power ensures ${T_motor_req.toFixed(1)} Nm constant torque up to ${Math.round(max_motor_rpm)} RPM`;
                    } else {
                        powerNoteEl.textContent = `Motor operates in constant power region above rated speed`;
                    }
                }
                
                // Add warning if torque requirement exceeds motor capability
                const T_motor_available = (P_rated_required * 1000) / (rpm_motor_effective <= max_motor_rpm ? omega_rated : omega_motor);
                if (T_motor_req > T_motor_available && Math.abs(T_motor_req - T_motor_available) > 0.1) {
                    console.warn(`Warning: Required torque ${T_motor_req.toFixed(2)} Nm exceeds available torque ${T_motor_available.toFixed(2)} Nm at ${rpm_motor_effective.toFixed(0)} RPM`);
                }
                outputs.peakTorque.innerText = Math.round(T_peak_required * safety_factor).toLocaleString();
                outputs.peakReason.innerText = peak_reason;
                if (isLinearMode) {
                    outputs.tStatic.innerText = Math.round(T_static).toLocaleString() + ' N';
                    outputs.tFric.innerText = Math.round(T_rolling).toLocaleString() + ' N';
                    outputs.tAccel.innerText = Math.round(T_accel).toLocaleString() + ' N';
                    if (outputs.brakeLabel) outputs.brakeLabel.textContent = 'Braking (Force)';
                    if (outputs.brake) outputs.brake.textContent = Math.round(F_brake).toLocaleString() + ' N';
                } else {
                    outputs.tStatic.innerText = Math.round(T_static).toLocaleString();
                    outputs.tFric.innerText = Math.round(T_rolling).toLocaleString();
                    outputs.tAccel.innerText = Math.round(T_accel).toLocaleString();
                    if (outputs.brakeLabel) outputs.brakeLabel.textContent = 'Braking (Torque)';
                    if (outputs.brake) outputs.brake.textContent = Math.round(T_brake).toLocaleString() + ' Nm';
                }
                // Display nominal tangential force (operating condition)
                outputs.forceWheel.innerText = (F_per_motor_nominal / 1000).toFixed(1);
                
                // Display Gearbox Torque Requirements
                outputs.gearboxNominal.innerText = Math.round(T_gearbox_nominal).toLocaleString();
                outputs.gearboxPeak.innerText = Math.round(T_gearbox_peak).toLocaleString();
                outputs.gearboxPeakMin.innerText = Math.round(T_gearbox_peak_min).toLocaleString();
                if (outputs.resSafetyFactor) outputs.resSafetyFactor.textContent = safety_factor;

            } else {
                // ... (Same Logic as before) ...
                const input_kw = parseFloat(inputs.inputPower.value);
                const rated_motor_rpm = getRatedMotorRpm();
                const omega_motor = rpm_motor_effective * 2 * Math.PI / 60;
                const omega_rated = rated_motor_rpm * 2 * Math.PI / 60;
                const T_rated = (input_kw * 1000) / omega_rated;
                if (outputs.motorRatedTorque) {
                    outputs.motorRatedTorque.innerText = T_rated.toFixed(2);
                }
                let T_motor_avail = 0;
                if (rpm_motor_effective <= rated_motor_rpm) {
                   T_motor_avail = T_rated;
                } else {
                   T_motor_avail = (input_kw * 1000) / omega_motor;
                }
                const T_drive_element_avail = T_motor_avail * gear_ratio * eta;
                const F_motor_avail = T_drive_element_avail / r_drive_element;
                let m_kg_static, m_kg_dynamic, max_mass_kg, limit_factor, T_static_disp, T_rolling_disp, T_accel_disp;
                if (isLinearMode) {
                    const F_avail_total = F_motor_avail * num_motors;
                    const v_linear_ms = getLinearSpeedMs() || 0.01;
                    const a_linear = t_accel > 0 ? v_linear_ms / t_accel : 0;
                    m_kg_static = F_avail_total / (mu_static * g);
                    m_kg_dynamic = F_avail_total / (mu_rolling * g + a_linear);
                    max_mass_kg = m_kg_static < m_kg_dynamic ? m_kg_static : m_kg_dynamic;
                    limit_factor = m_kg_static < m_kg_dynamic ? "Static Friction (Breakaway)" : "Acceleration";
                    T_static_disp = mu_static * max_mass_kg * g;
                    T_rolling_disp = mu_rolling * max_mass_kg * g;
                    T_accel_disp = max_mass_kg * a_linear;
                } else {
                    const T_stage_avail = (F_motor_avail * num_motors) * R_drive;
                    m_kg_static = T_stage_avail / (mu_static * g * R_stage);
                    const kinematic_factor = (mu_rolling * g * R_stage) + (0.5 * Math.pow(R_stage, 2) * alpha);
                    m_kg_dynamic = T_stage_avail / kinematic_factor;
                    max_mass_kg = m_kg_static < m_kg_dynamic ? m_kg_static : m_kg_dynamic;
                    limit_factor = m_kg_static < m_kg_dynamic ? "Static Friction (Breakaway)" : "Acceleration Torque";
                    T_static_disp = mu_static * max_mass_kg * g * R_stage;
                    T_rolling_disp = mu_rolling * max_mass_kg * g * R_stage;
                    const I_disp = 0.5 * max_mass_kg * Math.pow(R_stage, 2);
                    T_accel_disp = I_disp * alpha;
                }
                
                // Calculate Gearbox Output Torque (Reverse Mode)
                const T_gearbox_nominal_rev = T_drive_element_avail;
                const T_gearbox_peak_rev = T_drive_element_avail;
                const T_gearbox_peak_min_rev = T_gearbox_peak_rev * safety_factor;

                // Calculate TOTAL power requirement for building/facility
                const P_total_kw = input_kw * num_motors; // Total power for all motors
                
                // Calculate VA and Current for TOTAL system (3-phase 380V)
                // For building power assessment - calculate from TOTAL power
                const power_factor = 0.85; // Typical for induction motors
                const motor_eff = 0.85; // Motor Efficiency (distinct from Gearbox Efficiency)
                const V_line = 380; // Line voltage (V)
                const P_total_va = P_total_kw / (power_factor * motor_eff); // Total Apparent power in kVA
                const I_total_current = (P_total_kw * 1000) / (Math.sqrt(3) * V_line * power_factor * motor_eff); // Total Current per phase in A
                
                // Per motor values (for reference)
                const P_va_per_motor = input_kw / (power_factor * motor_eff);
                const I_current_per_motor = (input_kw * 1000) / (Math.sqrt(3) * V_line * power_factor * motor_eff);

                outputs.maxLoad.innerText = (max_mass_kg / 1000).toFixed(3);
                outputs.limitFactor.innerText = limit_factor;
                const T_stage_avail = !isLinearMode ? (F_motor_avail * num_motors) * R_drive : 0;
                outputs.peakTorque.innerText = Math.round(isLinearMode ? T_drive_element_avail : T_stage_avail).toLocaleString();
                outputs.peakReason.innerText = "Max Available Torque from Motors";
                if (isLinearMode) {
                    outputs.tStatic.innerText = Math.round(T_static_disp).toLocaleString() + ' N';
                    outputs.tFric.innerText = Math.round(T_rolling_disp).toLocaleString() + ' N';
                    outputs.tAccel.innerText = Math.round(T_accel_disp).toLocaleString() + ' N';
                    if (outputs.brakeLabel) outputs.brakeLabel.textContent = 'Braking (Force)';
                    if (outputs.brake) outputs.brake.textContent = '—';
                } else {
                    outputs.tStatic.innerText = Math.round(T_static_disp).toLocaleString();
                    outputs.tFric.innerText = Math.round(T_rolling_disp).toLocaleString();
                    outputs.tAccel.innerText = Math.round(T_accel_disp).toLocaleString();
                    if (outputs.brakeLabel) outputs.brakeLabel.textContent = 'Braking (Torque)';
                    if (outputs.brake) outputs.brake.textContent = '—';
                }
                outputs.forceWheel.innerText = (F_motor_avail / 1000).toFixed(1);
                
                // Display Gearbox Torque Requirements (Reverse Mode)
                outputs.gearboxNominal.innerText = Math.round(T_gearbox_nominal_rev).toLocaleString();
                outputs.gearboxPeak.innerText = Math.round(T_gearbox_peak_rev).toLocaleString();
                outputs.gearboxPeakMin.innerText = Math.round(T_gearbox_peak_min_rev).toLocaleString();

                // Update Reverse Mode Electrical Displays
                if (outputs.powerTotalRev) outputs.powerTotalRev.innerText = P_total_kw.toFixed(2);
                if (outputs.totalMotorsCountRev) outputs.totalMotorsCountRev.textContent = num_motors;
                if (outputs.powerVARev) outputs.powerVARev.innerText = P_total_va.toFixed(2);
                if (outputs.currentRev) outputs.currentRev.innerText = I_total_current.toFixed(2);
                
                // Keep updating the hidden Normal Mode elements too, just in case specific logic depends on them
                if (outputs.powerTotal) outputs.powerTotal.innerText = P_total_kw.toFixed(2);
                if (outputs.totalMotorsCount) outputs.totalMotorsCount.textContent = num_motors;
                if (outputs.powerVA) outputs.powerVA.innerText = P_total_va.toFixed(2);
                if (outputs.current) outputs.current.innerText = I_total_current.toFixed(2);
                
                // Store values for report (both per motor and total)
                window.currentMotorRpm = rpm_motor_effective;
                window.currentMotorPower = input_kw;
                window.currentMotorPowerTotal = P_total_kw;
                window.currentMotorVA = P_total_va; // Total VA
                window.currentMotorCurrent = I_total_current; // Total Current
                window.currentMotorVAPerMotor = P_va_per_motor;
                window.currentMotorCurrentPerMotor = I_current_per_motor;
                
                if(!isGearDrive) {
                    const F_down_req_N = F_motor_avail / mu_traction;
                    const F_down_req_Tons = F_down_req_N / g / 1000;
                    outputs.minWeight.innerText = F_down_req_Tons.toFixed(2);
                    checkTraction(F_down_req_Tons);
                } else {
                    outputs.tractionBox.classList.add('hidden');
                }
            }

            outputs.wheelRpm.innerText = Math.round(drive_element_rpm_final).toLocaleString();
            outputs.resDriveRad.innerText = isLinearMode ? '—' : R_drive.toFixed(2);
            const resLinearPitchRow = document.getElementById('res-linear-pitch-row');
            const resLinearPitchDia = document.getElementById('res-linear-pitch-dia');
            if (resLinearPitchRow && resLinearPitchDia) {
                if (isLinearMode && isGearDrive) {
                    resLinearPitchRow.classList.remove('hidden');
                    resLinearPitchDia.textContent = getLinearGearPitchDiaMm();
                } else {
                    resLinearPitchRow.classList.add('hidden');
                }
            }
            outputs.viewDim.innerText = D;
            outputs.viewDriveRad.innerText = isLinearMode ? '—' : R_drive.toFixed(1);
            const animRpmUnitEl = document.getElementById('anim-rpm-unit');
            const viewDimLabelEl = document.getElementById('view-dim-label');
            if (animRpmUnitEl) animRpmUnitEl.textContent = isLinearMode ? 'm/s' : 'RPM';
            if (viewDimLabelEl) viewDimLabelEl.textContent = isLinearMode ? 'Track' : 'Stage';

            handleWarnings(is_limited, isLinearMode ? getLinearSpeedMs() : rpm_stage_target);
            
            // Animation parameters (target values for visual)
            animationStageRpm = isLinearMode ? getLinearSpeedMs() : rpm_stage_target;
            if (isLinearMode) {
                const v_linear_ms = getLinearSpeedMs();
                animationDriveRpm = (v_linear_ms / (2 * Math.PI * r_drive_element)) * 60;
            } else if (isGearDrive) {
                animationDriveRpm = rpm_stage_target * ratio_stage_to_drive;
            } else {
                const wheel_mm = getWheelDiaMm();
                const r_wheel = (wheel_mm / 1000) / 2;
                const V_linear = (rpm_stage_target * 2 * Math.PI / 60) * R_drive;
                animationDriveRpm = (V_linear / r_wheel) * 60 / (2 * Math.PI);
            }
            
            update3DScene(D, num_motors, animationStageRpm, R_drive, animationDriveRpm);
        }

        function checkTraction(val) {
            if (val > 2.0) { 
                outputs.tractionBox.classList.remove('hidden');
            } else {
                outputs.tractionBox.classList.add('hidden');
            }
        }

        function handleWarnings(isLimited, target) {
            const speedUnitEl = document.getElementById('warn-speed-unit');
            if (speedUnitEl) speedUnitEl.textContent = isLinearMode ? 'm/s' : 'RPM';
            if (isLimited) {
                outputs.rpmWarning.classList.remove('hidden');
                outputs.warnTargetRpm.innerText = target.toFixed(2);
                outputs.warnActualRpm.innerText = actualStageRpm.toFixed(2);
                if(!isReverseMode) {
                    outputs.motorRpm.classList.add('text-red-400');
                    outputs.motorRpm.classList.remove('text-emerald-300');
                }
            } else {
                outputs.rpmWarning.classList.add('hidden');
                if(!isReverseMode) {
                    outputs.motorRpm.classList.remove('text-red-400');
                    outputs.motorRpm.classList.add('text-emerald-300');
                }
            }
            autoSave();
        }

        // --- 3D SCENE UPDATES ---
        let linearTrackLength = 20;
        let linearPlatformPosition = 0;

        function createRealisticMotorGroup(isGear, isLinear) {
            const root = new THREE.Group();
            const gray = new THREE.MeshStandardMaterial({ color: 0x4a5568, metalness: 0.6, roughness: 0.5 });
            const darkGray = new THREE.MeshStandardMaterial({ color: 0x2d3748, metalness: 0.5, roughness: 0.6 });
            const shaftGray = new THREE.MeshStandardMaterial({ color: 0x718096, metalness: 0.7, roughness: 0.4 });
            const gearboxMat = new THREE.MeshStandardMaterial({ color: 0x1e293b, metalness: 0.5, roughness: 0.5 });

            // Drive element (must be children[0] for animation)
            if (isGear) {
                const gearRing = new THREE.CylinderGeometry(0.15, 0.15, 0.28, 24);
                const gearMat = new THREE.MeshStandardMaterial({ color: 0xf59e0b, metalness: 0.6, roughness: 0.4 });
                const gear = new THREE.Mesh(gearRing, gearMat);
                gear.position.y = 0.5;
                root.add(gear);
            } else {
                const wheelRad = 0.2;
                const wheelCyl = new THREE.CylinderGeometry(wheelRad, wheelRad, 0.18, 24);
                wheelCyl.rotateX(Math.PI / 2);
                const wheelMat = new THREE.MeshStandardMaterial({ color: 0xef4444, metalness: 0.3, roughness: 0.5 });
                const wheel = new THREE.Mesh(wheelCyl, wheelMat);
                wheel.position.set(0, 0.2, 0);
                root.add(wheel);
                const hubGeo = new THREE.CylinderGeometry(0.06, 0.06, 0.2, 16);
                hubGeo.rotateX(Math.PI / 2);
                const hub = new THREE.Mesh(hubGeo, darkGray);
                hub.position.set(0, 0.2, 0);
                root.add(hub);
            }

            // Gearbox block (between motor and drive)
            const gb = new THREE.BoxGeometry(0.22, 0.2, 0.25);
            const gearbox = new THREE.Mesh(gb, gearboxMat);
            if (isLinear) {
                gearbox.position.set(-0.15, 0.35, 0);
            } else {
                gearbox.position.set(0, 0.35, -0.2);
            }
            root.add(gearbox);

            // Motor assembly (body, fins, fan, shaft, terminal, foot)
            const motorAssembly = new THREE.Group();
            const bodyRadius = 0.12;
            const bodyLen = 0.5;
            const bodyGeo = new THREE.CylinderGeometry(bodyRadius, bodyRadius, bodyLen, 24);
            bodyGeo.rotateZ(-Math.PI / 2);
            const body = new THREE.Mesh(bodyGeo, gray);
            body.castShadow = true;
            if (isLinear) {
                body.position.set(-0.45, 0.35, 0);
            } else {
                body.position.set(-0.25, 0.35, -0.5);
            }
            motorAssembly.add(body);

            for (let k = 0; k < 5; k++) {
                const fin = new THREE.BoxGeometry(0.02, bodyRadius * 2.2, bodyLen / 5.5);
                const finMesh = new THREE.Mesh(fin, darkGray);
                finMesh.rotation.z = -Math.PI / 2;
                if (isLinear) {
                    finMesh.position.set(-0.45 + (k - 2) * 0.08, 0.35, 0);
                } else {
                    finMesh.position.set(-0.5 + (k - 2) * 0.08, 0.35, -0.5);
                }
                motorAssembly.add(finMesh);
            }

            const fanGeo = new THREE.CylinderGeometry(bodyRadius * 1.15, bodyRadius * 1.15, 0.04, 24);
            fanGeo.rotateZ(-Math.PI / 2);
            const fan = new THREE.Mesh(fanGeo, darkGray);
            if (isLinear) {
                fan.position.set(-0.7, 0.35, 0);
            } else {
                fan.position.set(-0.5, 0.35, -0.5);
            }
            motorAssembly.add(fan);

            const shaftGeo = new THREE.CylinderGeometry(0.025, 0.025, 0.14, 12);
            shaftGeo.rotateZ(-Math.PI / 2);
            const shaft = new THREE.Mesh(shaftGeo, shaftGray);
            if (isLinear) {
                shaft.position.set(-0.2, 0.35, 0);
            } else {
                shaft.position.set(-0.08, 0.35, -0.2);
            }
            motorAssembly.add(shaft);

            const termBox = new THREE.BoxGeometry(0.1, 0.08, 0.06);
            const term = new THREE.Mesh(termBox, darkGray);
            if (isLinear) {
                term.position.set(-0.45, 0.42, 0);
            } else {
                term.position.set(-0.25, 0.42, -0.5);
            }
            motorAssembly.add(term);

            const foot = new THREE.BoxGeometry(0.35, 0.04, 0.12);
            const footMesh = new THREE.Mesh(foot, darkGray);
            if (isLinear) {
                footMesh.position.set(-0.45, 0.26, 0);
            } else {
                footMesh.position.set(-0.25, 0.26, -0.5);
            }
            motorAssembly.add(footMesh);

            root.add(motorAssembly);
            return root;
        }

        function update3DScene(diameter, motorCount, targetRpm, driveRadius, driveRpm) {
            if (!turntableGroup) return;

            while(turntableGroup.children.length > 0){ 
                turntableGroup.remove(turntableGroup.children[0]); 
            }

            if (isLinearMode) {
                linearTrackLength = diameter;
                const L = diameter;
                const trackWidth = 4;
                const railHeight = 0.3;
                const railGeo = new THREE.BoxGeometry(0.15, railHeight, L + 2);
                const railMat = new THREE.MeshStandardMaterial({ color: 0x475569, metalness: 0.6, roughness: 0.4 });
                const leftRail = new THREE.Mesh(railGeo, railMat);
                leftRail.position.set(-trackWidth / 2, railHeight / 2, 0);
                leftRail.castShadow = true;
                turntableGroup.add(leftRail);
                const rightRail = new THREE.Mesh(railGeo, railMat);
                rightRail.position.set(trackWidth / 2, railHeight / 2, 0);
                rightRail.castShadow = true;
                turntableGroup.add(rightRail);

                const platformWidth = trackWidth - 0.4;
                const platformDepth = 3;
                const platformHeight = 0.5;
                const platformGeo = new THREE.BoxGeometry(platformWidth, platformHeight, platformDepth);
                const platformMat = new THREE.MeshStandardMaterial({ 
                    color: inputs.colorStage ? inputs.colorStage.value : '#475569',
                    roughness: 0.5,
                    metalness: 0.7
                });
                stageMesh = new THREE.Mesh(platformGeo, platformMat);
                stageMesh.position.set(0, railHeight + platformHeight / 2, 0);
                linearPlatformPosition = 0;
                stageMesh.castShadow = true;
                stageMesh.receiveShadow = true;
                turntableGroup.add(stageMesh);

                motors.forEach(m => scene.remove(m));
                motors = [];
                const motorSpacing = L / (motorCount + 1);
                for (let i = 0; i < motorCount; i++) {
                    const zPos = -L / 2 + motorSpacing * (i + 1);
                    const motorGroup = createRealisticMotorGroup(isGearDrive, true);
                    motorGroup.position.set(-trackWidth / 2 - 0.5, 0, zPos);
                    motorGroup.rotation.y = Math.PI / 2;
                    scene.add(motorGroup);
                    motors.push(motorGroup);
                }
                return;
            }

            const R = diameter / 2;

            // Stage Cylinder
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#334155'; ctx.fillRect(0,0,512,512);
            ctx.strokeStyle = '#475569'; ctx.lineWidth = 5;
            ctx.beginPath(); ctx.arc(256, 256, 250, 0, Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0,256); ctx.lineTo(512,256); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(256,0); ctx.lineTo(256,512); ctx.stroke();
            
            const driveRingRatio = driveRadius / R;
            ctx.strokeStyle = isGearDrive ? '#f59e0b' : '#3b82f6'; 
            ctx.lineWidth = isGearDrive ? 6 : 2; 
            ctx.setLineDash(isGearDrive ? [] : [10, 10]);
            if (isGearDrive) ctx.setLineDash([5, 5]); 
            ctx.beginPath(); ctx.arc(256, 256, 250 * driveRingRatio, 0, Math.PI*2); ctx.stroke();

            const tex = new THREE.CanvasTexture(canvas);
            const geometry = new THREE.CylinderGeometry(R, R, 0.5, 64);
            const material = new THREE.MeshStandardMaterial({ 
                color: inputs.colorStage.value,
                map: tex,
                roughness: 0.5,
                metalness: 0.8
            });
            stageMesh = new THREE.Mesh(geometry, material);
            stageMesh.position.y = 0.5;
            stageMesh.castShadow = true;
            stageMesh.receiveShadow = true;
            turntableGroup.add(stageMesh);

            const centerGeo = new THREE.CylinderGeometry(0.2, 0.2, 0.6, 16);
            const centerMat = new THREE.MeshBasicMaterial({ color: 0x3b82f6 });
            const centerPin = new THREE.Mesh(centerGeo, centerMat);
            centerPin.position.y = 0.5;
            turntableGroup.add(centerPin);

            motors.forEach(m => scene.remove(m));
            motors = [];
            for (let i = 0; i < motorCount; i++) {
                const angle = (i / motorCount) * Math.PI * 2;
                const motorGroup = createRealisticMotorGroup(isGearDrive, false);
                const x = Math.cos(angle) * driveRadius;
                const z = Math.sin(angle) * driveRadius;
                motorGroup.position.set(x, 0, z);
                motorGroup.lookAt(0, 0, 0);
                scene.add(motorGroup);
                motors.push(motorGroup);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if (stageMesh) {
                if (isLinearMode) {
                    // Linear: move platform along Z (m/s -> m per frame at ~60fps)
                    const speedPerFrame = animationStageRpm / 60;
                    linearPlatformPosition += speedPerFrame;
                    if (linearPlatformPosition > linearTrackLength / 2) linearPlatformPosition -= linearTrackLength;
                    if (linearPlatformPosition < -linearTrackLength / 2) linearPlatformPosition += linearTrackLength;
                    stageMesh.position.z = linearPlatformPosition;
                    if (outputs.animRpm) outputs.animRpm.innerText = actualStageRpm.toFixed(1);
                    if (motors.length > 0) {
                        const omegaDrive = animationDriveRpm * (2 * Math.PI) / 60;
                        motors.forEach(group => {
                            if (group.children[0]) group.children[0].rotation.x += omegaDrive / 60;
                        });
                    }
                } else {
                    const omega = animationStageRpm * (2 * Math.PI) / 60;
                    if (outputs.animRpm) outputs.animRpm.innerText = actualStageRpm.toFixed(1);
                    stageMesh.rotation.y -= omega / 60; 
                    if (motors.length > 0) {
                        const omegaDrive = animationDriveRpm * (2 * Math.PI) / 60;
                        motors.forEach(group => {
                            if (group.children[0]) {
                                if (isGearDrive) {
                                    group.children[0].rotation.y += omegaDrive / 60; 
                                } else {
                                    group.children[0].rotation.z -= omegaDrive / 60; 
                                }
                            }
                        });
                    }
                }
            }
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            if (!container) return;
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // --- REPORT GENERATION ---
        function generateReport() {
            // Get current values
            const D = parseFloat(inputs.diameter.value);
            const num_motors = parseInt(inputs.motors.value);
            const gear_ratio = parseFloat(inputs.gearRatio.value);
            const eta = parseFloat(inputs.efficiency.value);
            const rpm_stage = parseFloat(inputs.rpm.value);
            const t_accel = parseFloat(inputs.accelTime.value);
            const t_decel = Math.max(0.5, parseFloat(inputs.decelTime?.value) || 15);
            const mu_rolling = parseFloat(inputs.muRolling.value);
            const mu_static = parseFloat(inputs.muStatic.value);
            const R_drive = parseFloat(inputs.driveRadiusSlider.value);
            const max_motor_rpm = parseFloat(inputs.maxMotorRpm.value);
            const safety_factor = Math.max(1, Math.min(3, parseFloat(inputs.safetyFactor?.value) || 1.5));
            
            let motorPowerPerMotor = 0;
            let motorRpm = 0;
            let totalPower = 0;
            let totalVA = 0;
            let totalCurrent = 0;
            let loadCapacity = 0;
            let reportTitleText = "";
            let loadLabelText = "";

            // Calculate Electrical values helper
            const calcElectrical = (p_total_kw) => {
                 const pf = 0.85; // Power Factor
                 const motor_eff = 0.85; // Assumed Motor Efficiency (Standard Induction Motor) - distinct from Gearbox Efficiency (eta)
                 const v = 380;
                 
                 // kVA = kW / (PF * Eff) -> This gives the Input Apparent Power
                 const va = p_total_kw / (pf * motor_eff);
                 
                 // Current = (kW * 1000) / (sqrt(3) * V * PF * Eff)
                 const i = (p_total_kw * 1000) / (Math.sqrt(3) * v * pf * motor_eff);
                 return { va, i };
            };

            if (!isReverseMode) {
                // --- CALC POWER (NORMAL MODE) ---
                reportTitleText = "Motor Sizing Report";
                loadLabelText = "Design Load Capacity:";
                
                // Get values from Calculation Results
                motorPowerPerMotor = parseFloat(outputs.power.innerText) || 0;
                motorRpm = parseInt(outputs.motorRpm.innerText.replace(/,/g, '')) || 0;
                loadCapacity = parseFloat(inputs.mass.value) || 0;
                
                // Calculate Totals based on Required Power
                totalPower = motorPowerPerMotor * num_motors;
                const elec = calcElectrical(totalPower);
                totalVA = elec.va;
                totalCurrent = elec.i;
                
            } else {
                // --- CALC LOAD (REVERSE MODE) ---
                reportTitleText = "Load Capacity Assessment Report";
                loadLabelText = "Max Permissible Load:";
                
                // Get values from Inputs (Installed Capacity)
                // FORCE READ from Input for consistency in Reverse Mode
                motorPowerPerMotor = parseFloat(inputs.inputPower.value) || 0;
                
                // Motor RPM in Reverse Mode: Use Rated Motor RPM from motor type
                motorRpm = getRatedMotorRpm();
                
                loadCapacity = parseFloat(outputs.maxLoad.innerText) || 0;
                
                // Calculate Totals based on Installed Power
                totalPower = motorPowerPerMotor * num_motors;
                const elec = calcElectrical(totalPower);
                totalVA = elec.va;
                totalCurrent = elec.i;
            }
            
            // Drive system info logic
            let driveType = isGearDrive ? 'Gear Drive' : 'Wheel Drive';
            let wheelDia = 0;
            let teethTurntable = 0;
            let teethPinion = 0;
            let gearRatioStage = 0;
            let totalRatio = 0;

            if (isGearDrive) {
                teethTurntable = parseInt(inputs.teethTurntable.value) || 0;
                teethPinion = parseInt(inputs.teethPinion.value) || 0;
                gearRatioStage = (teethTurntable / teethPinion).toFixed(2);
                totalRatio = gear_ratio * (teethTurntable / teethPinion);
            } else {
                wheelDia = getWheelDiaMm() || 0;
                totalRatio = gear_ratio;
            }
            
            // Peak torque
            const peakTorque = parseInt(outputs.peakTorque.innerText.replace(/,/g, '')) || 0;
            
            // Gearbox Torque values
            const gearboxNominal = parseInt(outputs.gearboxNominal.innerText.replace(/,/g, '')) || 0;
            const gearboxPeak = parseInt(outputs.gearboxPeak.innerText.replace(/,/g, '')) || 0;
            const gearboxPeakMin = parseInt(outputs.gearboxPeakMin.innerText.replace(/,/g, '')) || 0;
            
            // Update Report UI
            const titleEl = document.getElementById('report-title');
            if (titleEl) titleEl.innerHTML = `<i class="fa-solid fa-file-lines mr-2"></i>${reportTitleText}`;
            
            const loadLabelEl = document.getElementById('label-report-load');
            if (loadLabelEl) loadLabelEl.textContent = loadLabelText;
            
            const motorPowerHp = (motorPowerPerMotor * 1.34102).toFixed(2);
            document.getElementById('report-power').textContent = motorPowerPerMotor.toFixed(2) + ' kW (' + motorPowerHp + ' hp)';
            document.getElementById('report-motors').textContent = num_motors + ' units';
            document.getElementById('report-motor-rpm').textContent = Math.round(motorRpm).toLocaleString() + ' RPM';
            
            document.getElementById('report-total-power').textContent = totalPower.toFixed(2) + ' kW';
            
            // Electrical values (Total)
            const reportVAEl = document.getElementById('report-power-va');
            const reportCurrentEl = document.getElementById('report-current');
            const reportTotalVAEl = document.getElementById('report-total-power-va');
            const reportTotalCurrentEl = document.getElementById('report-total-current');
            
            if (reportVAEl) reportVAEl.textContent = totalVA.toFixed(2) + ' kVA';
            if (reportCurrentEl) reportCurrentEl.textContent = totalCurrent.toFixed(2) + ' A';
            if (reportTotalVAEl) reportTotalVAEl.textContent = totalVA.toFixed(2) + ' kVA';
            if (reportTotalCurrentEl) reportTotalCurrentEl.textContent = totalCurrent.toFixed(2) + ' A';
            
            document.getElementById('report-load').textContent = loadCapacity.toFixed(2) + ' Tons';
            document.getElementById('report-diameter').textContent = D.toFixed(1) + ' m';
            document.getElementById('report-stage-rpm').textContent = rpm_stage.toFixed(2) + ' RPM';
            
            document.getElementById('report-drive-type').textContent = driveType;
            
            // Wheel drive info
            if (!isGearDrive) {
                document.getElementById('report-wheel-info').classList.remove('hidden');
                document.getElementById('report-gear-info').classList.add('hidden');
                document.getElementById('report-wheel-dia').textContent = wheelDia.toFixed(0) + ' mm';
                document.getElementById('report-drive-radius').textContent = R_drive.toFixed(2) + ' m';
            } else {
                document.getElementById('report-wheel-info').classList.add('hidden');
                document.getElementById('report-gear-info').classList.remove('hidden');
                document.getElementById('report-teeth-turntable').textContent = teethTurntable;
                document.getElementById('report-teeth-pinion').textContent = teethPinion;
                document.getElementById('report-gear-ratio-stage').textContent = gearRatioStage + ':1';
                document.getElementById('report-gear-drive-radius').textContent = R_drive.toFixed(2) + ' m';
            }
            
            document.getElementById('report-gearbox-ratio').textContent = gear_ratio + ':1';
            document.getElementById('report-total-ratio').textContent = totalRatio.toFixed(2) + ':1';
            document.getElementById('report-efficiency').textContent = (eta * 100).toFixed(1) + '%';
            
            // Gearbox Torque Requirements
            document.getElementById('report-gearbox-nominal').textContent = gearboxNominal.toLocaleString() + ' Nm';
            document.getElementById('report-gearbox-peak').textContent = gearboxPeak.toLocaleString() + ' Nm';
            document.getElementById('report-gearbox-peak-min').textContent = gearboxPeakMin.toLocaleString() + ' Nm';
            const reportSfEl = document.getElementById('report-safety-factor');
            if (reportSfEl) reportSfEl.textContent = safety_factor;
            
            document.getElementById('report-peak-torque').textContent = peakTorque.toLocaleString() + ' Nm';
            document.getElementById('report-accel-time').textContent = t_accel.toFixed(1) + ' sec';
            document.getElementById('report-mu-rolling').textContent = mu_rolling.toFixed(3);
            document.getElementById('report-mu-static').textContent = mu_static.toFixed(3);
        }

        function exportPDF() {
            generateReport();

            const D = parseFloat(inputs.diameter.value);
            const num_motors = parseInt(inputs.motors.value);
            const gear_ratio = parseFloat(inputs.gearRatio.value);
            const eta = parseFloat(inputs.efficiency.value);
            const rpm_stage = parseFloat(inputs.rpm.value);
            const t_accel = parseFloat(inputs.accelTime.value);
            const t_decel = Math.max(0.5, parseFloat(inputs.decelTime?.value) || 15);
            const mu_rolling = parseFloat(inputs.muRolling.value);
            const mu_static = parseFloat(inputs.muStatic.value);
            const R_drive = parseFloat(inputs.driveRadiusSlider.value);
            const safety_factor = Math.max(1, Math.min(3, parseFloat(inputs.safetyFactor?.value) || 1.5));
            const pf = 0.85, mEff = 0.85, v = 380;

            let motorPower = 0, motorRpm = 0, totalPower = 0, totalVA = 0, totalCurrent = 0, loadCapacity = 0;
            let reportTitle = '', loadLabel = '', motorPowerLabel = '';
            let extraRows = '';

            if (!isReverseMode) {
                reportTitle = 'Motor Sizing Specification Report';
                loadLabel = 'Design Load (Input)';
                motorPowerLabel = 'Required Motor Power (per motor)';
                motorPower = parseFloat(outputs.power?.innerText) || 0;
                motorRpm = parseInt((outputs.motorRpm?.innerText || '0').replace(/,/g, '')) || 0;
                loadCapacity = parseFloat(inputs.mass.value) || 0;
                totalPower = motorPower * num_motors;
                totalVA = totalPower / (pf * mEff);
                totalCurrent = (totalPower * 1000) / (Math.sqrt(3) * v * pf * mEff);
                const stdMotor = (document.getElementById('res-standard-motor')?.innerText) || '-';
                const vfd = (document.getElementById('res-vfd')?.innerText) || '-';
                const vfdCur = (document.getElementById('res-vfd-current')?.innerText) || '-';
                extraRows = `
    <tr><td style="padding:3px 0;color:#64748b;">Recommended Std. Motor</td><td><b>${stdMotor} kW</b></td></tr>
    <tr><td style="padding:3px 0;color:#64748b;">Recommended VFD</td><td><b>${vfd} kW</b> (${vfdCur})</td></tr>`;
            } else {
                reportTitle = 'Load Capacity Assessment Report';
                loadLabel = 'Max Permissible Load (Result)';
                motorPowerLabel = 'Installed Motor Power (per motor)';
                motorPower = parseFloat(inputs.inputPower?.value) || 0;
                motorRpm = getRatedMotorRpm();
                loadCapacity = parseFloat(outputs.maxLoad?.innerText) || 0;
                totalPower = motorPower * num_motors;
                totalVA = totalPower / (pf * mEff);
                totalCurrent = (totalPower * 1000) / (Math.sqrt(3) * v * pf * mEff);
                const limitFactor = outputs.limitFactor?.innerText || '-';
                const ratedTorque = document.getElementById('res-motor-rated-torque')?.innerText || '-';
                extraRows = `
    <tr><td style="padding:3px 0;color:#64748b;">Limiting Factor</td><td style="color:#d97706;"><b>${limitFactor}</b></td></tr>
    <tr><td style="padding:3px 0;color:#64748b;">Motor Rated Torque</td><td>${ratedTorque} Nm</td></tr>`;
            }

            const peakTorque = parseInt((outputs.peakTorque?.innerText || '0').replace(/,/g, '')) || 0;
            const gearboxNominal = parseInt((outputs.gearboxNominal?.innerText || '0').replace(/,/g, '')) || 0;
            const gearboxPeak = parseInt((outputs.gearboxPeak?.innerText || '0').replace(/,/g, '')) || 0;
            const gearboxPeakMin = parseInt((outputs.gearboxPeakMin?.innerText || '0').replace(/,/g, '')) || 0;

            const tStatic = outputs.tStatic?.innerText || '0';
            const tFric = outputs.tFric?.innerText || '0';
            const tAccel = outputs.tAccel?.innerText || '0';
            const tBrake = outputs.brake?.textContent || '—';
            const peakReason = outputs.peakReason?.innerText || '';
            const torqueUnit = isLinearMode ? '' : ' Nm';
            const peakTorqueLabel = isReverseMode ? 'Max Available Torque' : 'Design Peak Torque (with SF)';

            let driveInfo = '';
            if (isGearDrive) {
                if (isLinearMode) {
                    const mod = parseFloat(inputs.linearGearModule?.value) || 0;
                    const teeth = parseInt(inputs.linearGearTeeth?.value) || 0;
                    const pcd = (mod * teeth).toFixed(1);
                    driveInfo = `
                        <tr><td>Transmission</td><td><b>Rack & Pinion</b></td></tr>
                        <tr><td>Module</td><td>${mod}</td></tr>
                        <tr><td>Pinion Teeth</td><td>${teeth}</td></tr>
                        <tr><td>Pitch Circle Dia.</td><td>${pcd} mm</td></tr>`;
                } else {
                    const tT = parseInt(inputs.teethTurntable.value) || 0;
                    const tP = parseInt(inputs.teethPinion.value) || 0;
                    const stageRatio = tP > 0 ? (tT / tP).toFixed(2) : '-';
                    driveInfo = `
                        <tr><td>Transmission</td><td><b>Gear Drive</b></td></tr>
                        <tr><td>Turntable Teeth</td><td>${tT}</td></tr>
                        <tr><td>Pinion Teeth</td><td>${tP}</td></tr>
                        <tr><td>Stage Gear Ratio</td><td>${stageRatio}:1</td></tr>
                        <tr><td>Drive Radius</td><td>${R_drive.toFixed(2)} m</td></tr>`;
                }
            } else {
                const wheelDia = getWheelDiaMm();
                driveInfo = `
                    <tr><td>Transmission</td><td><b>Wheel Drive</b></td></tr>
                    <tr><td>Wheel Diameter</td><td>${wheelDia.toFixed(0)} mm (${(wheelDia / 25.4).toFixed(2)} inch)</td></tr>
                    <tr><td>Drive Radius</td><td>${R_drive.toFixed(2)} m</td></tr>`;
            }

            const totalRatio = isGearDrive && !isLinearMode
                ? (gear_ratio * (parseInt(inputs.teethTurntable.value) || 1) / (parseInt(inputs.teethPinion.value) || 1)).toFixed(2)
                : gear_ratio.toFixed(2);

            const accelProfile = (document.querySelector('input[name="accelProfile"]:checked')?.value === 's-curve') ? 'S-Curve' : 'Linear (Trapezoidal)';
            const sCurveFactor = parseFloat(inputs.sCurveFactor?.value) || 1.0;

            const modeLabel = isLinearMode ? 'Linear Track' : 'Turntable';
            const speedLabel = isLinearMode ? 'Target Speed' : 'Target Stage Speed';
            const speedValue = isLinearMode
                ? (linearSpeedUnit === 'm/min' ? (rpm_stage / 60).toFixed(3) + ' m/s (' + rpm_stage.toFixed(2) + ' m/min)' : rpm_stage.toFixed(3) + ' m/s')
                : rpm_stage.toFixed(2) + ' RPM';
            const sizeLabel = isLinearMode ? 'Track Length' : 'Stage Diameter';
            const dateStr = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

            const calcModeBadge = isReverseMode
                ? '<span style="background:#d97706;color:#fff;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:bold;">CALC LOAD</span>'
                : '<span style="background:#059669;color:#fff;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:bold;">CALC POWER</span>';

            const max_motor_rpm = parseFloat(inputs.maxMotorRpm?.value) || 1500;
            const motorTorqueVal = outputs.motorTorque?.innerText || '-';
            const forceWheel = outputs.forceWheel?.innerText || '-';
            const wheelRpm = outputs.wheelRpm?.innerText || '-';
            const driveRad = outputs.resDriveRad?.innerText || '-';
            const minWeight = outputs.minWeight?.innerText || '-';
            const inertiaEl = document.getElementById('res-inertia-ratio');
            const inertiaRatio = inertiaEl && !document.getElementById('inertia-ratio-card')?.classList.contains('hidden') ? inertiaEl.textContent : null;

            const speedExceeded = !outputs.rpmWarning.classList.contains('hidden');
            const warnTarget = outputs.warnTargetRpm?.innerText || '';
            const warnActual = outputs.warnActualRpm?.innerText || '';
            const tractionVisible = !outputs.tractionBox.classList.contains('hidden');

            const speedUnit = isLinearMode ? 'm/s' : 'RPM';
            let warnings = [];
            if (speedExceeded) warnings.push(
                '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">'
                + '<span style="background:#dc2626;color:#fff;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:bold;">SPEED EXCEEDED</span>'
                + '<span style="color:#64748b;font-size:9px;">Target: <span style="text-decoration:line-through;color:#94a3b8;">' + warnTarget + ' ' + speedUnit + '</span></span>'
                + '<span style="font-size:9px;color:#64748b;">→</span>'
                + '<span style="font-size:13px;font-weight:bold;color:#dc2626;">Actual: ' + warnActual + ' ' + speedUnit + '</span>'
                + '<span style="font-size:8px;color:#94a3b8;">(Motor rated ' + max_motor_rpm.toLocaleString() + ' RPM — output capped)</span>'
                + '</div>');
            if (tractionVisible) warnings.push('<span style="color:#d97706;">⚠ Traction Risk: Min. downforce per wheel = ' + minWeight + ' Tons. Ensure sufficient wheel loading.</span>');
            if (inertiaRatio && parseFloat(inertiaRatio) > 10) warnings.push('<span style="color:#d97706;">⚠ High Inertia Ratio (JL/JM = ' + inertiaRatio + '): Consider higher gearbox ratio or larger servo.</span>');

            const r = (s) => `<tr><td style="padding:1px 0;color:#64748b;">${s.split('|')[0]}</td><td>${s.split('|')[1]}</td></tr>`;
            const hdr = (c,t) => `<div style="font-size:10px;font-weight:bold;color:${c};border-bottom:1px solid #cbd5e1;padding-bottom:2px;margin:8px 0 3px;">${t}</div>`;
            const tbl = (rows) => `<table style="width:100%;border-collapse:collapse;font-size:10px;">${rows}</table>`;

            const resultBox = isReverseMode
                ? `<div style="background:#fef3c7;border:1px solid #fbbf24;border-radius:4px;padding:6px 10px;margin-bottom:8px;">
                     <span style="font-size:9px;color:#92400e;font-weight:bold;">LOAD CAPACITY RESULT:</span>
                     <span style="font-size:16px;font-weight:bold;color:#065f46;margin-left:6px;">${loadCapacity.toFixed(3)} Tons</span>
                     <span style="font-size:9px;color:#92400e;margin-left:6px;">(${motorPower.toFixed(2)} kW × ${num_motors} = ${totalPower.toFixed(2)} kW installed)</span>
                   </div>`
                : `<div style="background:#ecfdf5;border:1px solid #34d399;border-radius:4px;padding:6px 10px;margin-bottom:8px;">
                     <span style="font-size:9px;color:#065f46;font-weight:bold;">MOTOR SIZING RESULT:</span>
                     <span style="font-size:16px;font-weight:bold;color:#065f46;margin-left:6px;">${motorPower.toFixed(2)} kW</span>
                     <span style="font-size:10px;color:#64748b;margin-left:4px;">(${(motorPower * 1.341).toFixed(2)} hp) per motor</span>
                     <span style="font-size:9px;color:#065f46;margin-left:6px;">for ${loadCapacity.toFixed(1)} T at ${speedValue}</span>
                   </div>`;

            const html = `
<div style="font-family:'Segoe UI',Arial,sans-serif;color:#1e293b;padding:12px 20px;max-width:700px;margin:auto;">
  <div style="text-align:center;border-bottom:2px solid #2563eb;padding-bottom:6px;margin-bottom:6px;">
    <div style="font-size:16px;font-weight:bold;color:#1e3a5f;margin:0;">Mechanic HOBOT Calculator v.1.4</div>
    <div style="font-size:9px;color:#94a3b8;margin-top:2px;">${reportTitle} &nbsp;|&nbsp; ${modeLabel} &nbsp;|&nbsp; ${dateStr} &nbsp;|&nbsp; ${calcModeBadge}</div>
  </div>
  ${warnings.length ? `
  <div style="border:1.5px solid #dc2626;border-radius:5px;padding:6px 10px;margin-bottom:6px;background:#fef2f2;">
    <div style="font-size:10px;font-weight:bold;color:#991b1b;margin-bottom:3px;">⚠ WARNINGS & NOTES</div>
    ${warnings.map(w => '<div style="font-size:9px;margin-bottom:2px;">' + w + '</div>').join('')}
  </div>` : ''}
  ${resultBox}
  <div style="display:flex;gap:12px;">
    <div style="flex:1;">
      ${hdr('#2563eb', isReverseMode ? 'Installed Motor' : 'Required Motor')}
      ${tbl(`
        ${r(motorPowerLabel + '|<b>' + motorPower.toFixed(2) + ' kW</b> (' + (motorPower*1.341).toFixed(2) + ' hp)')}
        ${extraRows}
        ${r('Motors|' + num_motors + ' units')}
        ${r('Motor Speed|' + motorRpm.toLocaleString() + ' RPM')}
        ${r('Total Power|<b>' + totalPower.toFixed(2) + ' kW</b>')}
        ${r('Apparent Power|' + totalVA.toFixed(2) + ' kVA')}
        ${r('Current (3φ 380V)|' + totalCurrent.toFixed(2) + ' A')}
      `)}
      ${hdr('#059669', 'Load & Geometry')}
      ${tbl(`
        ${r(loadLabel + '|<b>' + loadCapacity.toFixed(isReverseMode ? 3 : 1) + ' Tons</b>')}
        ${r(sizeLabel + '|' + D.toFixed(1) + ' m')}
        ${r(speedLabel + '|' + speedValue)}
      `)}
      ${hdr('#475569', 'Kinematics & Friction')}
      ${tbl(`
        ${r('Accel / Decel Time|' + t_accel.toFixed(1) + ' / ' + t_decel.toFixed(1) + ' sec')}
        ${r('Profile|' + accelProfile + (accelProfile.startsWith('S') ? ' (' + sCurveFactor + '×)' : ''))}
        ${r('μ Rolling / Static|' + mu_rolling.toFixed(3) + ' / ' + mu_static.toFixed(3))}
      `)}
    </div>
    <div style="flex:1;">
      ${hdr('#d97706', 'Drive System')}
      ${tbl(`
        ${driveInfo}
        ${r('Gearbox Ratio|' + gear_ratio + ':1')}
        ${r('Total Ratio|<b>' + totalRatio + ':1</b>')}
        ${r('Efficiency (η)|' + (eta * 100).toFixed(1) + '%')}
      `)}
      ${hdr('#7c3aed', 'Torque Analysis')}
      ${tbl(`
        ${r('Static (Breakaway)|' + tStatic + torqueUnit)}
        ${r('Rolling (Dynamic)|' + tFric + torqueUnit)}
        ${r('Acceleration|' + tAccel + torqueUnit)}
        ${r('Braking|' + tBrake)}
        <tr style="border-top:1px solid #e2e8f0;"><td style="padding:2px 0;color:#64748b;"><b>${peakTorqueLabel}</b></td><td><b>${peakTorque.toLocaleString()} ${isLinearMode ? '' : 'Nm'}</b></td></tr>
        <tr><td colspan="2" style="padding:0;color:#94a3b8;font-size:8px;"><i>${peakReason}</i></td></tr>
      `)}
      ${hdr('#d97706', 'Gearbox Selection')}
      ${tbl(`
        ${r('Nominal Torque|' + gearboxNominal.toLocaleString() + ' Nm')}
        ${r('Peak Torque|' + gearboxPeak.toLocaleString() + ' Nm')}
        ${r('Min. Recommended|<b style="color:#dc2626;">' + gearboxPeakMin.toLocaleString() + ' Nm</b>')}
        ${r('Safety Factor|' + safety_factor + '×')}
      `)}
      ${hdr('#475569', 'Drive Detail')}
      ${tbl(`
        ${r('Motor Torque|' + motorTorqueVal + ' Nm')}
        ${r('Tangential Force|' + forceWheel + ' kN')}
        ${r('Drive Element Speed|' + wheelRpm + ' RPM')}
        ${!isLinearMode ? r('Drive Radius|' + driveRad + ' m') : ''}
        ${r('Rated Motor Speed|' + max_motor_rpm.toLocaleString() + ' RPM')}
        ${r('Motor Type|' + (inputs.motorType?.value === 'induction' ? 'Induction (' + (inputs.motorPole?.value || '4') + 'P)' : 'Servo'))}
        ${inertiaRatio ? r('Inertia Ratio (JL/JM)|' + inertiaRatio) : ''}
        ${!isGearDrive ? r('Min. Wheel Downforce|' + minWeight + ' Tons') : ''}
      `)}
    </div>
  </div>
  <div style="margin-top:6px;border-top:1px solid #e2e8f0;padding-top:4px;text-align:center;font-size:8px;color:#94a3b8;">
    Mechanic HOBOT Calculator v.1.4 &mdash; Technical Specification Report &mdash; ${dateStr}
  </div>
</div>`;

            const wrapper = document.createElement('div');
            wrapper.innerHTML = html;
            wrapper.style.position = 'fixed';
            wrapper.style.left = '0';
            wrapper.style.top = '0';
            wrapper.style.width = '210mm';
            wrapper.style.background = '#ffffff';
            wrapper.style.zIndex = '-9999';
            document.body.appendChild(wrapper);

            const filename = 'Mechanic-HOBOT-Report-' + new Date().toISOString().slice(0, 10) + '.pdf';
            window.html2pdf().set({
                margin: [5, 5, 10, 5],
                filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0, backgroundColor: '#ffffff' },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['css', 'legacy'] }
            }).from(wrapper.firstElementChild).save().then(() => {
                document.body.removeChild(wrapper);
            }).catch(err => {
                console.error('html2pdf error:', err);
                document.body.removeChild(wrapper);
            });
        }

        init();

    </script>
</body>
</html>